<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Production Examples â€“ Nanobricks Wiki</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2757cfadcc89ddbfb9e61569f8c3689f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Nanobricks Wiki</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./quickstart.html"> 
<span class="menu-text">Quickstart</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tutorial.html"> 
<span class="menu-text">Tutorial</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./sdk-guide.html"> 
<span class="menu-text">SDK Guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./cookbook/index.html"> 
<span class="menu-text">Cookbook</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./roadmap.html"> 
<span class="menu-text">Roadmap</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-more" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">More</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-more">    
        <li>
    <a class="dropdown-item" href="./production-examples.html">
 <span class="dropdown-text">Production Examples</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./comparison.html">
 <span class="dropdown-text">Framework Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./architecture-diagrams.html">
 <span class="dropdown-text">Architecture Diagrams</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sdk-guide.html">Building Systems</a></li><li class="breadcrumb-item"><a href="./production-examples.html">Production Examples</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quickstart.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quickstart Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks Tutorial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./task-system.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Task System &amp; Commands</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./task-reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Task Reference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distribution &amp; Deployment</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Cookbook</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks Cookbook</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/basic-pipeline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Pipeline</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/dependency-injection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dependency Injection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/error-handling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Error Handling Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/testing-bricks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cookbook/composition-patterns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Composition vs Inheritance</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Building Systems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sdk-guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks SDK Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multi-project-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-Project Development</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./production-examples.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Production Examples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./patterns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configuration &amp; Feature Management</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Framework Comparison</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Core Concepts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./human.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks for Humans</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./design-philosophy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design Philosophy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Ten Commandments of Nanobricks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Architecture Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./architecture-diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Architecture Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./type-safety.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Type Safety in Nanobricks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./type-utilities.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Type Utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./naming-conventions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Naming Conventions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ai-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AI Integration Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ai-protocols.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AI Agent Protocols</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./superpowers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Skills</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Evolution</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project-history.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project History</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./evolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concept Evolution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./v1/concept.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks v1.0</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./v2/evolved-concept.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks v2.0</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanobricks Roadmap</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#example-1-user-management-api" id="toc-example-1-user-management-api" class="nav-link" data-scroll-target="#example-1-user-management-api">Example 1: User Management API</a>
  <ul class="collapse">
  <li><a href="#architecture-overview" id="toc-architecture-overview" class="nav-link" data-scroll-target="#architecture-overview">Architecture Overview</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a></li>
  <li><a href="#deployment" id="toc-deployment" class="nav-link" data-scroll-target="#deployment">Deployment</a></li>
  </ul></li>
  <li><a href="#example-2-real-time-data-processing-pipeline" id="toc-example-2-real-time-data-processing-pipeline" class="nav-link" data-scroll-target="#example-2-real-time-data-processing-pipeline">Example 2: Real-time Data Processing Pipeline</a>
  <ul class="collapse">
  <li><a href="#architecture" id="toc-architecture" class="nav-link" data-scroll-target="#architecture">Architecture</a></li>
  <li><a href="#implementation-1" id="toc-implementation-1" class="nav-link" data-scroll-target="#implementation-1">Implementation</a></li>
  <li><a href="#performance-optimization" id="toc-performance-optimization" class="nav-link" data-scroll-target="#performance-optimization">Performance Optimization</a></li>
  </ul></li>
  <li><a href="#example-3-e-commerce-order-processing-system" id="toc-example-3-e-commerce-order-processing-system" class="nav-link" data-scroll-target="#example-3-e-commerce-order-processing-system">Example 3: E-commerce Order Processing System</a>
  <ul class="collapse">
  <li><a href="#system-architecture" id="toc-system-architecture" class="nav-link" data-scroll-target="#system-architecture">System Architecture</a></li>
  <li><a href="#implementation-2" id="toc-implementation-2" class="nav-link" data-scroll-target="#implementation-2">Implementation</a></li>
  <li><a href="#testing-with-saga-compensation" id="toc-testing-with-saga-compensation" class="nav-link" data-scroll-target="#testing-with-saga-compensation">Testing with Saga Compensation</a></li>
  </ul></li>
  <li><a href="#example-4-ai-powered-customer-support-system" id="toc-example-4-ai-powered-customer-support-system" class="nav-link" data-scroll-target="#example-4-ai-powered-customer-support-system">Example 4: AI-Powered Customer Support System</a>
  <ul class="collapse">
  <li><a href="#implementation-3" id="toc-implementation-3" class="nav-link" data-scroll-target="#implementation-3">Implementation</a></li>
  </ul></li>
  <li><a href="#deployment-best-practices" id="toc-deployment-best-practices" class="nav-link" data-scroll-target="#deployment-best-practices">Deployment Best Practices</a>
  <ul class="collapse">
  <li><a href="#container-optimization" id="toc-container-optimization" class="nav-link" data-scroll-target="#container-optimization">1. Container Optimization</a></li>
  <li><a href="#kubernetes-production-config" id="toc-kubernetes-production-config" class="nav-link" data-scroll-target="#kubernetes-production-config">2. Kubernetes Production Config</a></li>
  <li><a href="#monitoring-setup" id="toc-monitoring-setup" class="nav-link" data-scroll-target="#monitoring-setup">3. Monitoring Setup</a></li>
  </ul></li>
  <li><a href="#performance-tuning" id="toc-performance-tuning" class="nav-link" data-scroll-target="#performance-tuning">Performance Tuning</a>
  <ul class="collapse">
  <li><a href="#database-connection-pooling" id="toc-database-connection-pooling" class="nav-link" data-scroll-target="#database-connection-pooling">Database Connection Pooling</a></li>
  <li><a href="#caching-strategy" id="toc-caching-strategy" class="nav-link" data-scroll-target="#caching-strategy">Caching Strategy</a></li>
  </ul></li>
  <li><a href="#security-hardening" id="toc-security-hardening" class="nav-link" data-scroll-target="#security-hardening">Security Hardening</a>
  <ul class="collapse">
  <li><a href="#api-security" id="toc-api-security" class="nav-link" data-scroll-target="#api-security">API Security</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sdk-guide.html">Building Systems</a></li><li class="breadcrumb-item"><a href="./production-examples.html">Production Examples</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Production Examples</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Real-world applications built with Nanobricks</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This guide contains complete, production-ready examples showing how to build real applications with Nanobricks. Each example includes error handling, monitoring, deployment configuration, and best practices.</p>
</section>
<section id="example-1-user-management-api" class="level2">
<h2 class="anchored" data-anchor-id="example-1-user-management-api">Example 1: User Management API</h2>
<p>A complete user management service with authentication, validation, and database persistence.</p>
<section id="architecture-overview" class="level3">
<h3 class="anchored" data-anchor-id="architecture-overview">Architecture Overview</h3>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>graph LR</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    A[HTTP Request] --&gt; B[Rate Limiter]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Authenticator]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Request Validator]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    D --&gt; E[User Service]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    E --&gt; F[Database]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    E --&gt; G[Cache]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    E --&gt; H[Event Bus]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    H --&gt; I[Email Service]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    H --&gt; J[Analytics]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    A[HTTP Request] --&gt; B[Rate Limiter]
    B --&gt; C[Authenticator]
    C --&gt; D[Request Validator]
    D --&gt; E[User Service]
    E --&gt; F[Database]
    E --&gt; G[Cache]
    E --&gt; H[Event Bus]
    H --&gt; I[Email Service]
    H --&gt; J[Analytics]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<div id="dbe45f4b" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> NanobrickBase, NanobrickSimple, create_service</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.skills <span class="im">import</span> skill</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Pipeline, Branch, Fallback</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.security <span class="im">import</span> hash_password, verify_password</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncpg</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis.asyncio <span class="im">as</span> redis</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Dict, List</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>JWT_SECRET <span class="op">=</span> <span class="st">"your-secret-key"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>JWT_ALGORITHM <span class="op">=</span> <span class="st">"HS256"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>JWT_EXPIRATION <span class="op">=</span> timedelta(hours<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Dependencies</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ServiceDeps(TypedDict):</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    db: asyncpg.Pool</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    cache: redis.Redis</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    event_bus: EventBus</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    config: Dict</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Models</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, EmailStr</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCreate(BaseModel):</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    email: EmailStr</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    full_name: <span class="bu">str</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(BaseModel):</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span>: <span class="bu">str</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    email: <span class="bu">str</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    full_name: <span class="bu">str</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    created_at: datetime</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    active: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginRequest(BaseModel):</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    email: EmailStr</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Core Nanobricks</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateUserData(NanobrickSimple[UserCreate, UserCreate]):</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates user registration data."""</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> UserCreate:</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(data.password) <span class="op">&lt;</span> <span class="dv">8</span>:</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Password must be at least 8 characters"</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> data.full_name.strip():</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Full name is required"</span>)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckEmailUniqueness(NanobrickBase[UserCreate, UserCreate, ServiceDeps]):</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Ensures email is not already registered."""</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> UserCreate:</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        existing <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SELECT id FROM users WHERE email = $1"</span>,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            data.email</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> existing:</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Email </span><span class="sc">{</span>data<span class="sc">.</span>email<span class="sc">}</span><span class="ss"> is already registered"</span>)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HashUserPassword(NanobrickSimple[UserCreate, Dict]):</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Hashes the user password securely."""</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        user_dict <span class="op">=</span> data.<span class="bu">dict</span>()</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        user_dict[<span class="st">"password_hash"</span>] <span class="op">=</span> <span class="cf">await</span> hash_password(data.password)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> user_dict[<span class="st">"password"</span>]</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user_dict</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreateUserInDB(NanobrickBase[Dict, User, ServiceDeps]):</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates user in database."""</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user_data: Dict, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="st">            INSERT INTO users (email, password_hash, full_name, created_at)</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="st">            VALUES ($1, $2, $3, $4)</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a><span class="st">            RETURNING id, email, full_name, created_at, active</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, </span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"email"</span>],</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"password_hash"</span>],</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"full_name"</span>],</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>            datetime.utcnow()</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> User(<span class="op">**</span><span class="bu">dict</span>(result))</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CacheUser(NanobrickBase[User, User, ServiceDeps]):</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Caches user data for fast retrieval."""</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        cache_key <span class="op">=</span> <span class="ss">f"user:</span><span class="sc">{</span>user<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>            cache_key,</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>            <span class="dv">3600</span>,  <span class="co"># 1 hour TTL</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>            user.json()</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EmitUserCreatedEvent(NanobrickBase[User, User, ServiceDeps]):</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Emits event for other services to react."""</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"event_bus"</span>].emit(<span class="st">"user.created"</span>, {</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">"user_id"</span>: user.<span class="bu">id</span>,</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">"email"</span>: user.email,</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow().isoformat()</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Compose the registration pipeline</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>registration_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    ValidateUserData(),</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    CheckEmailUniqueness(),</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    HashUserPassword(),</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    CreateUserInDB(),</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    CacheUser(),</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    EmitUserCreatedEvent()</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"logging"</span>, level<span class="op">=</span><span class="st">"INFO"</span>)</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a> .with_skill(<span class="st">"observability"</span>, service_name<span class="op">=</span><span class="st">"user-service"</span>)</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Authentication bricks</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateCredentials(NanobrickBase[LoginRequest, User, ServiceDeps]):</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates user credentials."""</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, request: LoginRequest, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT id, email, password_hash, full_name, created_at, active</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM users WHERE email = $1</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, request.email)</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result:</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid credentials"</span>)</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="cf">await</span> verify_password(request.password, result[<span class="st">"password_hash"</span>]):</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid credentials"</span>)</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> User(</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span>result[<span class="st">"id"</span>],</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>            email<span class="op">=</span>result[<span class="st">"email"</span>],</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>            full_name<span class="op">=</span>result[<span class="st">"full_name"</span>],</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>            created_at<span class="op">=</span>result[<span class="st">"created_at"</span>],</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>            active<span class="op">=</span>result[<span class="st">"active"</span>]</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateJWT(NanobrickSimple[User, Dict]):</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates JWT token for authenticated user."""</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>        payload <span class="op">=</span> {</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sub"</span>: user.<span class="bu">id</span>,</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>            <span class="st">"email"</span>: user.email,</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"exp"</span>: datetime.utcnow() <span class="op">+</span> JWT_EXPIRATION</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>        token <span class="op">=</span> jwt.encode(payload, JWT_SECRET, algorithm<span class="op">=</span>JWT_ALGORITHM)</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>            <span class="st">"access_token"</span>: token,</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>            <span class="st">"token_type"</span>: <span class="st">"bearer"</span>,</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>            <span class="st">"user"</span>: user.<span class="bu">dict</span>()</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Login pipeline</span></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>login_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>    ValidateCredentials(),</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    GenerateJWT()</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"logging"</span>)</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="co"># User lookup with caching</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetUserById(NanobrickBase[<span class="bu">str</span>, User, ServiceDeps]):</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gets user by ID with cache fallback."""</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user_id: <span class="bu">str</span>, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try cache first</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>        cache_key <span class="op">=</span> <span class="ss">f"user:</span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>        cached <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"cache"</span>].get(cache_key)</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cached:</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> User.parse_raw(cached)</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load from database</span></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT id, email, full_name, created_at, active</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM users WHERE id = $1</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, user_id)</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result:</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"User </span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss"> not found"</span>)</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> User(<span class="op">**</span><span class="bu">dict</span>(result))</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update cache</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(cache_key, <span class="dv">3600</span>, user.json())</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the complete service</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"api"</span>, port<span class="op">=</span><span class="dv">8000</span>, title<span class="op">=</span><span class="st">"User Management API"</span>)</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"docker"</span>, base_image<span class="op">=</span><span class="st">"python:3.13-slim"</span>)</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"kubernetes"</span>, replicas<span class="op">=</span><span class="dv">3</span>, autoscale<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserManagementService:</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete user management service."""</span></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register <span class="op">=</span> registration_pipeline</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.login <span class="op">=</span> login_pipeline</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_user <span class="op">=</span> GetUserById()</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create_user(<span class="va">self</span>, user_data: UserCreate) <span class="op">-&gt;</span> User:</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /users - Create new user"""</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.register.invoke(user_data, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> authenticate(<span class="va">self</span>, credentials: LoginRequest) <span class="op">-&gt;</span> Dict:</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /auth/login - Authenticate user"""</span></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.login.invoke(credentials, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> get_user_by_id(<span class="va">self</span>, user_id: <span class="bu">str</span>) <span class="op">-&gt;</span> User:</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""GET /users/{user_id} - Get user by ID"""</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.get_user.invoke(user_id, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> health_check(<span class="va">self</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""GET /health - Health check endpoint"""</span></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>            <span class="st">"status"</span>: <span class="st">"healthy"</span>,</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow().isoformat(),</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>            <span class="st">"service"</span>: <span class="st">"user-management"</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Deployment configuration</span></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> asyncio</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize dependencies</span></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>        db <span class="op">=</span> <span class="cf">await</span> asyncpg.create_pool(<span class="st">"postgresql://localhost/users"</span>)</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>        cache <span class="op">=</span> <span class="cf">await</span> redis.from_url(<span class="st">"redis://localhost"</span>)</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>        event_bus <span class="op">=</span> EventBus()</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>        deps <span class="op">=</span> ServiceDeps(</span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>            db<span class="op">=</span>db,</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">=</span>cache,</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>            event_bus<span class="op">=</span>event_bus,</span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>{<span class="st">"environment"</span>: <span class="st">"production"</span>}</span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create and start service</span></span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>        service <span class="op">=</span> UserManagementService(deps)</span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.start_server()</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>    asyncio.run(main())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testing" class="level3">
<h3 class="anchored" data-anchor-id="testing">Testing</h3>
<div id="d00ea7e9" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.testing <span class="im">import</span> create_test_client</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_deps():</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create test dependencies with mocks."""</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ServiceDeps(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        db<span class="op">=</span>MockDatabase(),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">=</span>MockCache(),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        event_bus<span class="op">=</span>MockEventBus(),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>{<span class="st">"environment"</span>: <span class="st">"test"</span>}</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_user_registration(test_deps):</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> UserManagementService(test_deps)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    user_data <span class="op">=</span> UserCreate(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        email<span class="op">=</span><span class="st">"test@example.com"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        password<span class="op">=</span><span class="st">"securepass123"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        full_name<span class="op">=</span><span class="st">"Test User"</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> <span class="cf">await</span> service.create_user(user_data)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.email <span class="op">==</span> <span class="st">"test@example.com"</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.full_name <span class="op">==</span> <span class="st">"Test User"</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.<span class="bu">id</span> <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_duplicate_email(test_deps):</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> UserManagementService(test_deps)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create first user</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    user_data <span class="op">=</span> UserCreate(</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        email<span class="op">=</span><span class="st">"test@example.com"</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        password<span class="op">=</span><span class="st">"securepass123"</span>,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        full_name<span class="op">=</span><span class="st">"Test User"</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> service.create_user(user_data)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to create with same email</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>, match<span class="op">=</span><span class="st">"already registered"</span>):</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.create_user(user_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deployment" class="level3">
<h3 class="anchored" data-anchor-id="deployment">Deployment</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.yml</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.8'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">user-service</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8000:8000"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> DATABASE_URL=postgresql://postgres:password@db/users</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> REDIS_URL=redis://redis:6379</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> db</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> redis</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">db</span><span class="kw">:</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:15</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_DB=users</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD=password</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> postgres_data:/var/lib/postgresql/data</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">redis</span><span class="kw">:</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> redis:7-alpine</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> redis_data:/data</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres_data</span><span class="kw">:</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">redis_data</span><span class="kw">:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="example-2-real-time-data-processing-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="example-2-real-time-data-processing-pipeline">Example 2: Real-time Data Processing Pipeline</h2>
<p>A production data pipeline that processes streaming data with validation, transformation, and storage.</p>
<section id="architecture" class="level3">
<h3 class="anchored" data-anchor-id="architecture">Architecture</h3>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    A[Kafka Stream] --&gt; B[Message Consumer]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Schema Validator]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Data Enricher]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    D --&gt; E[Business Rules]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    E --&gt; F{Router}</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    F --&gt;|Type A| G[Processor A]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    F --&gt;|Type B| H[Processor B]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    G --&gt; I[Aggregator]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    H --&gt; I</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    I --&gt; J[Data Lake]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    I --&gt; K[Analytics DB]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    I --&gt; L[Real-time Dashboard]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TB
    A[Kafka Stream] --&gt; B[Message Consumer]
    B --&gt; C[Schema Validator]
    C --&gt; D[Data Enricher]
    D --&gt; E[Business Rules]
    E --&gt; F{Router}
    F --&gt;|Type A| G[Processor A]
    F --&gt;|Type B| H[Processor B]
    G --&gt; I[Aggregator]
    H --&gt; I
    I --&gt; J[Data Lake]
    I --&gt; K[Analytics DB]
    I --&gt; L[Real-time Dashboard]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="implementation-1" class="level3">
<h3 class="anchored" data-anchor-id="implementation-1">Implementation</h3>
<div id="e3a30f97" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> NanobrickBase, NanobrickSimple, create_pipeline</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Router, Parallel, Window</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Any</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiokafka</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data models</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SensorReading(BaseModel):</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    sensor_id: <span class="bu">str</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    timestamp: datetime</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    temperature: <span class="bu">float</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    humidity: <span class="bu">float</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    location: Dict[<span class="bu">str</span>, <span class="bu">float</span>]  <span class="co"># lat, lon</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnrichedReading(SensorReading):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    city: <span class="bu">str</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    country: <span class="bu">str</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    weather_conditions: <span class="bu">str</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    anomaly_score: <span class="bu">float</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Processing bricks</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateSensorData(NanobrickSimple[Dict, SensorReading]):</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates and parses raw sensor data."""</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, raw_data: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> SensorReading:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            reading <span class="op">=</span> SensorReading(<span class="op">**</span>raw_data)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Validate ranges</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="op">-</span><span class="dv">50</span> <span class="op">&lt;=</span> reading.temperature <span class="op">&lt;=</span> <span class="dv">70</span>:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid temperature: </span><span class="sc">{</span>reading<span class="sc">.</span>temperature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="dv">0</span> <span class="op">&lt;=</span> reading.humidity <span class="op">&lt;=</span> <span class="dv">100</span>:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid humidity: </span><span class="sc">{</span>reading<span class="sc">.</span>humidity<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> reading</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log to dead letter queue</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid sensor data: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnrichWithLocation(NanobrickBase[SensorReading, EnrichedReading, ServiceDeps]):</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Enriches reading with location data."""</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, reading: SensorReading, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> EnrichedReading:</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get location from cache or API</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        location_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>reading<span class="sc">.</span>location[<span class="st">'lat'</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>reading<span class="sc">.</span>location[<span class="st">'lon'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        location_data <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"cache"</span>].get(location_key)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> location_data:</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Call geocoding API</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            location_data <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"geocoding_api"</span>].reverse_geocode(</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>                reading.location[<span class="st">'lat'</span>],</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>                reading.location[<span class="st">'lon'</span>]</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(location_key, <span class="dv">86400</span>, location_data)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EnrichedReading(</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>reading.<span class="bu">dict</span>(),</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>            city<span class="op">=</span>location_data[<span class="st">'city'</span>],</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            country<span class="op">=</span>location_data[<span class="st">'country'</span>],</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>            weather_conditions<span class="op">=</span><span class="st">"normal"</span>,  <span class="co"># Would call weather API</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>            anomaly_score<span class="op">=</span><span class="fl">0.0</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DetectAnomalies(NanobrickBase[EnrichedReading, EnrichedReading, ServiceDeps]):</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Detects anomalies using ML model."""</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, reading: EnrichedReading, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> EnrichedReading:</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use pre-trained model</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> deps[<span class="st">"ml_models"</span>][<span class="st">"anomaly_detector"</span>]</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>            reading.temperature,</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>            reading.humidity,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>            reading.timestamp.hour,</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>            reading.timestamp.weekday()</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        anomaly_score <span class="op">=</span> model.predict_proba([features])[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        reading.anomaly_score <span class="op">=</span> <span class="bu">float</span>(anomaly_score)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> anomaly_score <span class="op">&gt;</span> <span class="fl">0.8</span>:</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Trigger alert</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"event_bus"</span>].emit(<span class="st">"anomaly.detected"</span>, {</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sensor_id"</span>: reading.sensor_id,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>                <span class="st">"score"</span>: anomaly_score,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>                <span class="st">"reading"</span>: reading.<span class="bu">dict</span>()</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> reading</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AggregateReadings(NanobrickSimple[List[EnrichedReading], Dict]):</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aggregates readings for analytics."""</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, readings: List[EnrichedReading], <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame([r.<span class="bu">dict</span>() <span class="cf">for</span> r <span class="kw">in</span> readings])</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow(),</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"count"</span>: <span class="bu">len</span>(readings),</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">"avg_temperature"</span>: df[<span class="st">'temperature'</span>].mean(),</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">"avg_humidity"</span>: df[<span class="st">'humidity'</span>].mean(),</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">"anomaly_count"</span>: <span class="bu">len</span>(df[df[<span class="st">'anomaly_score'</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>]),</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"by_city"</span>: df.groupby(<span class="st">'city'</span>).agg({</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>                <span class="st">'temperature'</span>: <span class="st">'mean'</span>,</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>                <span class="st">'humidity'</span>: <span class="st">'mean'</span>,</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sensor_id'</span>: <span class="st">'count'</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>            }).to_dict()</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Create processing pipeline</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"monitoring"</span>, metrics<span class="op">=</span>[<span class="st">"throughput"</span>, <span class="st">"latency"</span>, <span class="st">"errors"</span>])</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"scaling"</span>, auto_scale<span class="op">=</span><span class="va">True</span>, min_instances<span class="op">=</span><span class="dv">2</span>, max_instances<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SensorDataPipeline:</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Real-time sensor data processing pipeline."""</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Main processing pipeline</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.process_reading <span class="op">=</span> Pipeline(</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>            ValidateSensorData(),</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>            EnrichWithLocation(),</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>            DetectAnomalies()</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        ).with_skill(<span class="st">"retry"</span>, max_attempts<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Aggregation window</span></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.windowed_aggregation <span class="op">=</span> Window(</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>            window_size<span class="op">=</span>timedelta(minutes<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>            aggregator<span class="op">=</span>AggregateReadings()</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Storage writers</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lake_writer <span class="op">=</span> DataLakeWriter()</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.analytics_writer <span class="op">=</span> AnalyticsDBWriter()</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dashboard_updater <span class="op">=</span> DashboardUpdater()</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parallel output</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_handlers <span class="op">=</span> Parallel([</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lake_writer,</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.analytics_writer,</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dashboard_updater</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> start(<span class="va">self</span>):</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Start consuming from Kafka."""</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>        consumer <span class="op">=</span> aiokafka.AIOKafkaConsumer(</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sensor-readings'</span>,</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>            bootstrap_servers<span class="op">=</span><span class="st">'localhost:9092'</span>,</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>            group_id<span class="op">=</span><span class="st">'sensor-processor'</span>,</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>            value_deserializer<span class="op">=</span><span class="kw">lambda</span> m: json.loads(m.decode(<span class="st">'utf-8'</span>))</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> consumer.start()</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>            <span class="cf">async</span> <span class="cf">for</span> msg <span class="kw">in</span> consumer:</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Process individual reading</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>                    reading <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.process_reading.invoke(</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>                        msg.value,</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>                        deps<span class="op">=</span><span class="va">self</span>.deps</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add to aggregation window</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="va">self</span>.windowed_aggregation.add(reading)</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if window is ready</span></span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.windowed_aggregation.is_ready():</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>                        aggregated <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.windowed_aggregation.invoke()</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">await</span> <span class="va">self</span>.output_handlers.invoke(aggregated, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Send to dead letter queue</span></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"dead_letter_queue"</span>].send({</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"error"</span>: <span class="bu">str</span>(e),</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"message"</span>: msg.value,</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> consumer.stop()</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitoring and alerting</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PipelineMonitor(NanobrickSimple[Dict, <span class="va">None</span>]):</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Monitors pipeline health and sends alerts."""</span></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, thresholds: Dict):</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.thresholds <span class="op">=</span> thresholds</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, metrics: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check error rate</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metrics[<span class="st">'error_rate'</span>] <span class="op">&gt;</span> <span class="va">self</span>.thresholds[<span class="st">'max_error_rate'</span>]:</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"alerting"</span>].send_alert(</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>                severity<span class="op">=</span><span class="st">"high"</span>,</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span><span class="ss">f"High error rate: </span><span class="sc">{</span>metrics[<span class="st">'error_rate'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>,</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>                runbook_url<span class="op">=</span><span class="st">"https://wiki/sensor-pipeline-errors"</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check latency</span></span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metrics[<span class="st">'p99_latency'</span>] <span class="op">&gt;</span> <span class="va">self</span>.thresholds[<span class="st">'max_latency_ms'</span>]:</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"alerting"</span>].send_alert(</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>                severity<span class="op">=</span><span class="st">"medium"</span>,</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span><span class="ss">f"High latency: </span><span class="sc">{</span>metrics[<span class="st">'p99_latency'</span>]<span class="sc">}</span><span class="ss">ms"</span>,</span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>                runbook_url<span class="op">=</span><span class="st">"https://wiki/sensor-pipeline-latency"</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="performance-optimization" class="level3">
<h3 class="anchored" data-anchor-id="performance-optimization">Performance Optimization</h3>
<div id="2d5ca850" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add performance optimizations</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>optimized_pipeline <span class="op">=</span> (</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    SensorDataPipeline(deps)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"cache"</span>, ttl<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"batch"</span>, size<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"profile"</span>, trace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure for high throughput</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>high_throughput_config <span class="op">=</span> {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"consumer"</span>: {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fetch_min_bytes"</span>: <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>,  <span class="co"># 1MB</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_poll_records"</span>: <span class="dv">500</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"processing"</span>: {</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"parallelism"</span>: <span class="dv">8</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_timeout_ms"</span>: <span class="dv">100</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"output"</span>: {</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"compression"</span>: <span class="st">"snappy"</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_size"</span>: <span class="dv">1000</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="example-3-e-commerce-order-processing-system" class="level2">
<h2 class="anchored" data-anchor-id="example-3-e-commerce-order-processing-system">Example 3: E-commerce Order Processing System</h2>
<p>A complete order processing system with inventory management, payment processing, and fulfillment.</p>
<section id="system-architecture" class="level3">
<h3 class="anchored" data-anchor-id="system-architecture">System Architecture</h3>
<div class="cell" data-layout-align="default">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    subgraph "Order Service"</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        A[Order API] --&gt; B[Order Validator]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        B --&gt; C[Inventory Check]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        C --&gt; D[Price Calculator]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        D --&gt; E[Payment Processor]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    subgraph "Inventory Service"</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        C --&gt; F[Stock Manager]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        F --&gt; G[Warehouse API]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    subgraph "Payment Service"</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        E --&gt; H[Payment Gateway]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        H --&gt; I[Fraud Detection]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    subgraph "Fulfillment Service"</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        E --&gt; J[Order Queue]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        J --&gt; K[Shipping Calculator]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        K --&gt; L[Label Generator]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        L --&gt; M[Tracking Service]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    end</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TB
    subgraph "Order Service"
        A[Order API] --&gt; B[Order Validator]
        B --&gt; C[Inventory Check]
        C --&gt; D[Price Calculator]
        D --&gt; E[Payment Processor]
    end
    
    subgraph "Inventory Service"
        C --&gt; F[Stock Manager]
        F --&gt; G[Warehouse API]
    end
    
    subgraph "Payment Service"
        E --&gt; H[Payment Gateway]
        H --&gt; I[Fraud Detection]
    end
    
    subgraph "Fulfillment Service"
        E --&gt; J[Order Queue]
        J --&gt; K[Shipping Calculator]
        K --&gt; L[Label Generator]
        L --&gt; M[Tracking Service]
    end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="implementation-2" class="level3">
<h3 class="anchored" data-anchor-id="implementation-2">Implementation</h3>
<div id="da8165bb" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> create_microservice, NanobrickBase</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Saga, Compensate</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stripe</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Domain models</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderItem(BaseModel):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    product_id: <span class="bu">str</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    quantity: <span class="bu">int</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    unit_price: Decimal</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Order(BaseModel):</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span>: <span class="bu">str</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    customer_id: <span class="bu">str</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    items: List[OrderItem]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    shipping_address: Dict</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    total: Decimal <span class="op">=</span> Decimal(<span class="st">"0"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span> <span class="op">=</span> <span class="st">"pending"</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Inventory management</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckInventory(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Checks and reserves inventory."""</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        inventory_service <span class="op">=</span> deps[<span class="st">"inventory_service"</span>]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check availability for all items</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> order.items:</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            available <span class="op">=</span> <span class="cf">await</span> inventory_service.check_stock(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                item.product_id,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                item.quantity</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> available:</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Insufficient stock for product </span><span class="sc">{</span>item<span class="sc">.</span>product_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reserve inventory</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        reservation_id <span class="op">=</span> <span class="cf">await</span> inventory_service.reserve_items(</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            [(item.product_id, item.quantity) <span class="cf">for</span> item <span class="kw">in</span> order.items],</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            duration_minutes<span class="op">=</span><span class="dv">30</span>  <span class="co"># 30 minute reservation</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store reservation ID for potential rollback</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        order.metadata <span class="op">=</span> {<span class="st">"reservation_id"</span>: reservation_id}</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> compensate(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Release inventory reservation on failure."""</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> reservation_id <span class="op">:=</span> order.metadata.get(<span class="st">"reservation_id"</span>):</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"inventory_service"</span>].release_reservation(reservation_id)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CalculatePricing(NanobrickSimple[Order, Order]):</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculates order total with taxes and discounts."""</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, tax_rate: Decimal <span class="op">=</span> Decimal(<span class="st">"0.08"</span>)):</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tax_rate <span class="op">=</span> tax_rate</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Order:</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        subtotal <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            item.quantity <span class="op">*</span> item.unit_price </span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> order.items</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply discounts</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>        discount <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.calculate_discount(order, subtotal)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate tax</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>        taxable_amount <span class="op">=</span> subtotal <span class="op">-</span> discount</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>        tax <span class="op">=</span> taxable_amount <span class="op">*</span> <span class="va">self</span>.tax_rate</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add shipping</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>        shipping <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.calculate_shipping(order)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>        order.total <span class="op">=</span> taxable_amount <span class="op">+</span> tax <span class="op">+</span> shipping</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        order.breakdown <span class="op">=</span> {</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"subtotal"</span>: subtotal,</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"discount"</span>: discount,</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tax"</span>: tax,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping"</span>: shipping,</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total"</span>: order.total</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessPayment(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Processes payment through payment gateway."""</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        stripe.api_key <span class="op">=</span> deps[<span class="st">"config"</span>][<span class="st">"stripe_api_key"</span>]</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create payment intent</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>            intent <span class="op">=</span> stripe.PaymentIntent.create(</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>                amount<span class="op">=</span><span class="bu">int</span>(order.total <span class="op">*</span> <span class="dv">100</span>),  <span class="co"># Convert to cents</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>                currency<span class="op">=</span><span class="st">"usd"</span>,</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>                customer<span class="op">=</span>order.customer_id,</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>                metadata<span class="op">=</span>{</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"order_id"</span>: order.<span class="bu">id</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process payment</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>            payment <span class="op">=</span> stripe.PaymentIntent.confirm(</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>                intent.<span class="bu">id</span>,</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>                payment_method<span class="op">=</span>order.payment_method_id</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> payment.status <span class="op">==</span> <span class="st">"succeeded"</span>:</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>                order.status <span class="op">=</span> <span class="st">"paid"</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>                order.payment_id <span class="op">=</span> payment.<span class="bu">id</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Payment failed: </span><span class="sc">{</span>payment<span class="sc">.</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> stripe.error.CardError <span class="im">as</span> e:</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Card declined: </span><span class="sc">{</span>e<span class="sc">.</span>user_message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> compensate(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Refund payment on failure."""</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> payment_id <span class="op">:=</span> <span class="bu">getattr</span>(order, <span class="st">"payment_id"</span>, <span class="va">None</span>):</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>            stripe.Refund.create(payment_intent<span class="op">=</span>payment_id)</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreateFulfillment(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates fulfillment order for shipping."""</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        fulfillment_service <span class="op">=</span> deps[<span class="st">"fulfillment_service"</span>]</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate shipping options</span></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        shipping_options <span class="op">=</span> <span class="cf">await</span> fulfillment_service.calculate_shipping(</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>            items<span class="op">=</span>order.items,</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>            destination<span class="op">=</span>order.shipping_address</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select best option (could be user preference)</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>        selected_option <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>            shipping_options,</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"cost"</span>] <span class="op">+</span> x[<span class="st">"days"</span>] <span class="op">*</span> <span class="dv">5</span>  <span class="co"># Balance cost and speed</span></span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create fulfillment order</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>        fulfillment <span class="op">=</span> <span class="cf">await</span> fulfillment_service.create_order({</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>            <span class="st">"order_id"</span>: order.<span class="bu">id</span>,</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>            <span class="st">"items"</span>: order.items,</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping_address"</span>: order.shipping_address,</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping_method"</span>: selected_option[<span class="st">"method"</span>],</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>            <span class="st">"expected_delivery"</span>: selected_option[<span class="st">"estimated_delivery"</span>]</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>        order.fulfillment_id <span class="op">=</span> fulfillment[<span class="st">"id"</span>]</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>        order.tracking_number <span class="op">=</span> fulfillment[<span class="st">"tracking_number"</span>]</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>        order.status <span class="op">=</span> <span class="st">"processing"</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Create order processing saga</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>order_saga <span class="op">=</span> Saga(</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"order_processing"</span>,</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>        CheckInventory(),</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>        CalculatePricing(),</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>        ProcessPayment(),</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>        CreateFulfillment()</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>    compensation_strategy<span class="op">=</span><span class="st">"reverse"</span>  <span class="co"># Compensate in reverse order</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"monitoring"</span>, track_compensation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Order service with event sourcing</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"api"</span>, port<span class="op">=</span><span class="dv">8001</span>)</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"event_sourcing"</span>, store<span class="op">=</span><span class="st">"postgresql"</span>)</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderProcessingService:</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete order processing service."""</span></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.saga <span class="op">=</span> order_saga</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event handlers for async processing</span></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.event_handlers <span class="op">=</span> {</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>            <span class="st">"order.created"</span>: <span class="va">self</span>.handle_order_created,</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>            <span class="st">"payment.completed"</span>: <span class="va">self</span>.handle_payment_completed,</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fulfillment.shipped"</span>: <span class="va">self</span>.handle_order_shipped</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create_order(<span class="va">self</span>, order_data: Dict) <span class="op">-&gt;</span> Order:</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /orders - Create new order"""</span></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> Order(<span class="op">**</span>order_data)</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>        order.<span class="bu">id</span> <span class="op">=</span> generate_order_id()</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process through saga</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>            processed_order <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.saga.invoke(order, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Emit success event</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"event_bus"</span>].emit(<span class="st">"order.completed"</span>, {</span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>                <span class="st">"order"</span>: processed_order.<span class="bu">dict</span>(),</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> processed_order</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Saga will handle compensation</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"event_bus"</span>].emit(<span class="st">"order.failed"</span>, {</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>                <span class="st">"order_id"</span>: order.<span class="bu">id</span>,</span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>                <span class="st">"error"</span>: <span class="bu">str</span>(e),</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> handle_order_shipped(<span class="va">self</span>, event: Dict):</span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Handle shipment notification."""</span></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>        order_id <span class="op">=</span> event[<span class="st">"order_id"</span>]</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>        tracking_info <span class="op">=</span> event[<span class="st">"tracking_info"</span>]</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update order status</span></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"db"</span>].execute(<span class="st">"""</span></span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a><span class="st">            UPDATE orders </span></span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a><span class="st">            SET status = 'shipped',</span></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a><span class="st">                tracking_number = $1,</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a><span class="st">                shipped_at = $2</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a><span class="st">            WHERE id = $3</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, tracking_info[<span class="st">"tracking_number"</span>], datetime.utcnow(), order_id)</span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notify customer</span></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"notification_service"</span>].send_email(</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>            template<span class="op">=</span><span class="st">"order_shipped"</span>,</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>            order_id<span class="op">=</span>order_id,</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>            tracking_info<span class="op">=</span>tracking_info</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testing-with-saga-compensation" class="level3">
<h3 class="anchored" data-anchor-id="testing-with-saga-compensation">Testing with Saga Compensation</h3>
<div id="bee5eaff" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_payment_failure_compensation():</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test that inventory is released when payment fails."""</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mock payment to fail</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    deps <span class="op">=</span> create_test_deps()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    deps[<span class="st">"payment_service"</span>].mock_failure <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> OrderProcessingService(deps)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    order_data <span class="op">=</span> {</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"customer_id"</span>: <span class="st">"cust_123"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"items"</span>: [</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"product_id"</span>: <span class="st">"prod_1"</span>, <span class="st">"quantity"</span>: <span class="dv">2</span>, <span class="st">"unit_price"</span>: <span class="st">"29.99"</span>}</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shipping_address"</span>: {...}</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This should fail at payment step</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>, match<span class="op">=</span><span class="st">"Payment failed"</span>):</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.create_order(order_data)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify compensation occurred</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> deps[<span class="st">"inventory_service"</span>].reservations <span class="op">==</span> {}  <span class="co"># Released</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> deps[<span class="st">"metrics"</span>][<span class="st">"compensations_triggered"</span>] <span class="op">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="example-4-ai-powered-customer-support-system" class="level2">
<h2 class="anchored" data-anchor-id="example-4-ai-powered-customer-support-system">Example 4: AI-Powered Customer Support System</h2>
<p>An intelligent support system using nanobricks with AI capabilities.</p>
<section id="implementation-3" class="level3">
<h3 class="anchored" data-anchor-id="implementation-3">Implementation</h3>
<div id="1d6eef28" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.ai <span class="im">import</span> AIBrick, ConversationMemory</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.skills <span class="im">import</span> create_mcp_server</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnalyzeSentiment(AIBrick[<span class="bu">str</span>, Dict]):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Analyzes customer sentiment using AI."""</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-4"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">100</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, message: <span class="bu">str</span>, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.complete(</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            system<span class="op">=</span><span class="st">"Analyze sentiment and urgency of customer message"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>message,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            response_format<span class="op">=</span>{<span class="st">"sentiment"</span>: <span class="st">"positive/neutral/negative"</span>, <span class="st">"urgency"</span>: <span class="st">"low/medium/high"</span>}</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateResponse(AIBrick[Dict, <span class="bu">str</span>]):</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates contextual support response."""</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, knowledge_base: KnowledgeBase):</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(model<span class="op">=</span><span class="st">"gpt-4"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kb <span class="op">=</span> knowledge_base</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, context: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get relevant knowledge</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        docs <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.kb.search(</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            context[<span class="st">"message"</span>],</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">=</span><span class="dv">3</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.complete(</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>            system<span class="op">=</span><span class="st">"""You are a helpful customer support agent.</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="st">            Use the provided documentation to answer accurately.</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="st">            Be concise and friendly."""</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>context[<span class="st">"message"</span>],</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>            context<span class="op">=</span>{<span class="st">"documentation"</span>: docs},</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">500</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Create intelligent support pipeline</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>support_pipeline <span class="op">=</span> (</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    AnalyzeSentiment()</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> RouteByUrgency()</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> LoadCustomerHistory()</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> GenerateResponse(knowledge_base)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> ValidateResponse()</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"conversation_memory"</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a> .with_skill(<span class="st">"observability"</span>, track_ai_usage<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="deployment-best-practices" class="level2">
<h2 class="anchored" data-anchor-id="deployment-best-practices">Deployment Best Practices</h2>
<section id="container-optimization" class="level3">
<h3 class="anchored" data-anchor-id="container-optimization">1. Container Optimization</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-stage build for smaller images</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.13-slim as builder</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> requirements.txt .</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--user</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.13-slim</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy only necessary files</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /root/.local /root/.local</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> src/ ./src/</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> nanobrick.toml .</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-root user</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">useradd</span> <span class="at">-m</span> <span class="at">-u</span> 1000 appuser</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="kw">USER</span> appuser</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH=/root/.local/bin:$PATH</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"python"</span>, <span class="st">"-m"</span>, <span class="st">"nanobricks.run"</span>, <span class="st">"my-service"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="kubernetes-production-config" class="level3">
<h3 class="anchored" data-anchor-id="kubernetes-production-config">2. Kubernetes Production Config</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> service</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> myregistry/nanobrick-service:v1.0.0</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ENVIRONMENT</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">value</span><span class="kw">:</span><span class="at"> production</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"256Mi"</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"100m"</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /ready</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> autoscaling/v2</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> HorizontalPodAutoscaler</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service-hpa</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scaleTargetRef</span><span class="kw">:</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">maxReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics</span><span class="kw">:</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cpu</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">70</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> memory</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="monitoring-setup" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-setup">3. Monitoring Setup</h3>
<div id="3619706e" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.observability <span class="im">import</span> create_monitoring_stack</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>monitoring <span class="op">=</span> create_monitoring_stack(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    service_name<span class="op">=</span><span class="st">"my-service"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Metrics with Prometheus</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>{</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://prometheus:9090"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"custom_metrics"</span>: [</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"orders_processed_total"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"payment_amount_sum"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"processing_duration_seconds"</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tracing with Jaeger</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    tracing<span class="op">=</span>{</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://jaeger:14268"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_rate"</span>: <span class="fl">0.1</span>  <span class="co"># 10% sampling</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logging with ELK</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    logging<span class="op">=</span>{</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://elasticsearch:9200"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"index"</span>: <span class="st">"nanobricks-prod"</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"retention_days"</span>: <span class="dv">30</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerting rules</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    alerts<span class="op">=</span>[</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: <span class="st">"high_error_rate"</span>,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"condition"</span>: <span class="st">"rate(errors_total[5m]) &gt; 0.01"</span>,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"severity"</span>: <span class="st">"critical"</span>,</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"notify"</span>: [<span class="st">"oncall@company.com"</span>]</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: <span class="st">"high_latency"</span>, </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"condition"</span>: <span class="st">"histogram_quantile(0.99, latency_seconds) &gt; 1"</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"severity"</span>: <span class="st">"warning"</span>,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"notify"</span>: [<span class="st">"team@company.com"</span>]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="performance-tuning" class="level2">
<h2 class="anchored" data-anchor-id="performance-tuning">Performance Tuning</h2>
<section id="database-connection-pooling" class="level3">
<h3 class="anchored" data-anchor-id="database-connection-pooling">Database Connection Pooling</h3>
<div id="4fdf11e0" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.performance <span class="im">import</span> create_connection_pool</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>db_pool <span class="op">=</span> create_connection_pool(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"postgresql://localhost/mydb"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    min_connections<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    max_connections<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    connection_timeout<span class="op">=</span><span class="fl">5.0</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    idle_timeout<span class="op">=</span><span class="fl">300.0</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    max_lifetime<span class="op">=</span><span class="fl">3600.0</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Use with nanobricks</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>deps <span class="op">=</span> ServiceDeps(db<span class="op">=</span>db_pool, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="caching-strategy" class="level3">
<h3 class="anchored" data-anchor-id="caching-strategy">Caching Strategy</h3>
<div id="cca4e3f0" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.performance <span class="im">import</span> MultiLevelCache</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> MultiLevelCache(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L1: In-memory LRU cache</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    memory_cache<span class="op">=</span>{<span class="st">"max_size"</span>: <span class="dv">1000</span>, <span class="st">"ttl"</span>: <span class="dv">60</span>},</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L2: Redis cache</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    redis_cache<span class="op">=</span>{<span class="st">"url"</span>: <span class="st">"redis://localhost"</span>, <span class="st">"ttl"</span>: <span class="dv">3600</span>},</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L3: CDN cache (for read-through)</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    cdn_cache<span class="op">=</span>{<span class="st">"enabled"</span>: <span class="va">True</span>, <span class="st">"regions"</span>: [<span class="st">"us-east-1"</span>, <span class="st">"eu-west-1"</span>]}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to expensive operations</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>cached_processor <span class="op">=</span> processor.with_skill(<span class="st">"cache"</span>, cache<span class="op">=</span>cache)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="security-hardening" class="level2">
<h2 class="anchored" data-anchor-id="security-hardening">Security Hardening</h2>
<section id="api-security" class="level3">
<h3 class="anchored" data-anchor-id="api-security">API Security</h3>
<div id="6f92d55f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.security <span class="im">import</span> secure_api</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>secure_service <span class="op">=</span> secure_api(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    service,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Authentication</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    auth<span class="op">=</span>{</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type"</span>: <span class="st">"jwt"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"secret"</span>: JWT_SECRET,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"algorithm"</span>: <span class="st">"RS256"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"issuer"</span>: <span class="st">"https://auth.company.com"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rate limiting per user</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    rate_limit<span class="op">=</span>{</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"requests_per_minute"</span>: <span class="dv">100</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"burst"</span>: <span class="dv">20</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"key"</span>: <span class="kw">lambda</span> req: req.user_id</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Input validation</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    validation<span class="op">=</span>{</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_body_size"</span>: <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>,  <span class="co"># 1MB</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"allowed_content_types"</span>: [<span class="st">"application/json"</span>],</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"schema_validation"</span>: <span class="va">True</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Security headers</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"X-Frame-Options"</span>: <span class="st">"DENY"</span>,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"X-Content-Type-Options"</span>: <span class="st">"nosniff"</span>,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Strict-Transport-Security"</span>: <span class="st">"max-age=31536000"</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>These production examples demonstrate:</p>
<ol type="1">
<li><strong>Complete Systems</strong>: Full applications built with nanobricks</li>
<li><strong>Error Handling</strong>: Proper error handling and compensation</li>
<li><strong>Testing</strong>: Comprehensive testing strategies</li>
<li><strong>Deployment</strong>: Production-ready deployment configurations</li>
<li><strong>Monitoring</strong>: Observability and alerting setup</li>
<li><strong>Performance</strong>: Optimization techniques</li>
<li><strong>Security</strong>: Hardening for production use</li>
</ol>
<p>Each example can be adapted and extended for your specific use case. The modular nature of nanobricks makes it easy to swap components, add new features, or scale specific parts of your system independently.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Production Examples"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Real-world applications built with Nanobricks"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>This guide contains complete, production-ready examples showing how to build real applications with Nanobricks. Each example includes error handling, monitoring, deployment configuration, and best practices.</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example 1: User Management API</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>A complete user management service with authentication, validation, and database persistence.</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="fu">### Architecture Overview</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>graph LR</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    A[HTTP Request] --&gt; B[Rate Limiter]</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Authenticator]</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Request Validator]</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    D --&gt; E[User Service]</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    E --&gt; F[Database]</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    E --&gt; G[Cache]</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    E --&gt; H[Event Bus]</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    H --&gt; I[Email Service]</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    H --&gt; J[Analytics]</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> NanobrickBase, Nanobrick, create_service</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.skills <span class="im">import</span> skill</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Pipeline, Branch, Fallback</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.security <span class="im">import</span> hash_password, verify_password</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncpg</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis.asyncio <span class="im">as</span> redis</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Dict, List</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>JWT_SECRET <span class="op">=</span> <span class="st">"your-secret-key"</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>JWT_ALGORITHM <span class="op">=</span> <span class="st">"HS256"</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>JWT_EXPIRATION <span class="op">=</span> timedelta(hours<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Dependencies</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ServiceDeps(TypedDict):</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    db: asyncpg.Pool</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    cache: redis.Redis</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    event_bus: EventBus</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    config: Dict</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Models</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, EmailStr</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCreate(BaseModel):</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    email: EmailStr</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    full_name: <span class="bu">str</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(BaseModel):</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span>: <span class="bu">str</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    email: <span class="bu">str</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    full_name: <span class="bu">str</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    created_at: datetime</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    active: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginRequest(BaseModel):</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    email: EmailStr</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Core Nanobricks</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateUserData(Nanobrick[UserCreate, UserCreate]):</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates user registration data."""</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> UserCreate:</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(data.password) <span class="op">&lt;</span> <span class="dv">8</span>:</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Password must be at least 8 characters"</span>)</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> data.full_name.strip():</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Full name is required"</span>)</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckEmailUniqueness(NanobrickBase[UserCreate, UserCreate, ServiceDeps]):</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Ensures email is not already registered."""</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> UserCreate:</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>        existing <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SELECT id FROM users WHERE email = $1"</span>,</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>            data.email</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> existing:</span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Email </span><span class="sc">{</span>data<span class="sc">.</span>email<span class="sc">}</span><span class="ss"> is already registered"</span>)</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HashUserPassword(Nanobrick[UserCreate, Dict]):</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Hashes the user password securely."""</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, data: UserCreate, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>        user_dict <span class="op">=</span> data.<span class="bu">dict</span>()</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>        user_dict[<span class="st">"password_hash"</span>] <span class="op">=</span> <span class="cf">await</span> hash_password(data.password)</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> user_dict[<span class="st">"password"</span>]</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user_dict</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreateUserInDB(NanobrickBase[Dict, User, ServiceDeps]):</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates user in database."""</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user_data: Dict, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a><span class="st">            INSERT INTO users (email, password_hash, full_name, created_at)</span></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a><span class="st">            VALUES ($1, $2, $3, $4)</span></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a><span class="st">            RETURNING id, email, full_name, created_at, active</span></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, </span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"email"</span>],</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"password_hash"</span>],</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>            user_data[<span class="st">"full_name"</span>],</span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>            datetime.utcnow()</span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> User(<span class="op">**</span><span class="bu">dict</span>(result))</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CacheUser(NanobrickBase[User, User, ServiceDeps]):</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Caches user data for fast retrieval."""</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>        cache_key <span class="op">=</span> <span class="ss">f"user:</span><span class="sc">{</span>user<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(</span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a>            cache_key,</span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>            <span class="dv">3600</span>,  <span class="co"># 1 hour TTL</span></span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>            user.json()</span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EmitUserCreatedEvent(NanobrickBase[User, User, ServiceDeps]):</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Emits event for other services to react."""</span></span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"event_bus"</span>].emit(<span class="st">"user.created"</span>, {</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>            <span class="st">"user_id"</span>: user.<span class="bu">id</span>,</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>            <span class="st">"email"</span>: user.email,</span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow().isoformat()</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Compose the registration pipeline</span></span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>registration_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>    ValidateUserData(),</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>    CheckEmailUniqueness(),</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>    HashUserPassword(),</span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a>    CreateUserInDB(),</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>    CacheUser(),</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>    EmitUserCreatedEvent()</span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"logging"</span>, level<span class="op">=</span><span class="st">"INFO"</span>)</span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a> .with_skill(<span class="st">"observability"</span>, service_name<span class="op">=</span><span class="st">"user-service"</span>)</span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Authentication bricks</span></span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateCredentials(NanobrickBase[LoginRequest, User, ServiceDeps]):</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates user credentials."""</span></span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, request: LoginRequest, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT id, email, password_hash, full_name, created_at, active</span></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM users WHERE email = $1</span></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, request.email)</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result:</span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid credentials"</span>)</span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="cf">await</span> verify_password(request.password, result[<span class="st">"password_hash"</span>]):</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid credentials"</span>)</span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> User(</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span>result[<span class="st">"id"</span>],</span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>            email<span class="op">=</span>result[<span class="st">"email"</span>],</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>            full_name<span class="op">=</span>result[<span class="st">"full_name"</span>],</span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>            created_at<span class="op">=</span>result[<span class="st">"created_at"</span>],</span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>            active<span class="op">=</span>result[<span class="st">"active"</span>]</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateJWT(Nanobrick[User, Dict]):</span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates JWT token for authenticated user."""</span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user: User, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>        payload <span class="op">=</span> {</span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sub"</span>: user.<span class="bu">id</span>,</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>            <span class="st">"email"</span>: user.email,</span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>            <span class="st">"exp"</span>: datetime.utcnow() <span class="op">+</span> JWT_EXPIRATION</span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>        token <span class="op">=</span> jwt.encode(payload, JWT_SECRET, algorithm<span class="op">=</span>JWT_ALGORITHM)</span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>            <span class="st">"access_token"</span>: token,</span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>            <span class="st">"token_type"</span>: <span class="st">"bearer"</span>,</span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>            <span class="st">"user"</span>: user.<span class="bu">dict</span>()</span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Login pipeline</span></span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>login_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>    ValidateCredentials(),</span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>    GenerateJWT()</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"logging"</span>)</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a><span class="co"># User lookup with caching</span></span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetUserById(NanobrickBase[<span class="bu">str</span>, User, ServiceDeps]):</span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gets user by ID with cache fallback."""</span></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, user_id: <span class="bu">str</span>, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> User:</span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try cache first</span></span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>        cache_key <span class="op">=</span> <span class="ss">f"user:</span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>        cached <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"cache"</span>].get(cache_key)</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cached:</span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> User.parse_raw(cached)</span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load from database</span></span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"db"</span>].fetchrow(<span class="st">"""</span></span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT id, email, full_name, created_at, active</span></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM users WHERE id = $1</span></span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, user_id)</span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result:</span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"User </span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss"> not found"</span>)</span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> User(<span class="op">**</span><span class="bu">dict</span>(result))</span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update cache</span></span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(cache_key, <span class="dv">3600</span>, user.json())</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user</span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the complete service</span></span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"api"</span>, port<span class="op">=</span><span class="dv">8000</span>, title<span class="op">=</span><span class="st">"User Management API"</span>)</span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"docker"</span>, base_image<span class="op">=</span><span class="st">"python:3.13-slim"</span>)</span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"kubernetes"</span>, replicas<span class="op">=</span><span class="dv">3</span>, autoscale<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserManagementService:</span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete user management service."""</span></span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register <span class="op">=</span> registration_pipeline</span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.login <span class="op">=</span> login_pipeline</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_user <span class="op">=</span> GetUserById()</span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create_user(<span class="va">self</span>, user_data: UserCreate) <span class="op">-&gt;</span> User:</span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /users - Create new user"""</span></span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.register.invoke(user_data, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> authenticate(<span class="va">self</span>, credentials: LoginRequest) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /auth/login - Authenticate user"""</span></span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.login.invoke(credentials, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> get_user_by_id(<span class="va">self</span>, user_id: <span class="bu">str</span>) <span class="op">-&gt;</span> User:</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""GET /users/{user_id} - Get user by ID"""</span></span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.get_user.invoke(user_id, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> health_check(<span class="va">self</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""GET /health - Health check endpoint"""</span></span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>            <span class="st">"status"</span>: <span class="st">"healthy"</span>,</span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow().isoformat(),</span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>            <span class="st">"service"</span>: <span class="st">"user-management"</span></span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Deployment configuration</span></span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> asyncio</span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize dependencies</span></span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a>        db <span class="op">=</span> <span class="cf">await</span> asyncpg.create_pool(<span class="st">"postgresql://localhost/users"</span>)</span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a>        cache <span class="op">=</span> <span class="cf">await</span> redis.from_url(<span class="st">"redis://localhost"</span>)</span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a>        event_bus <span class="op">=</span> EventBus()</span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a>        deps <span class="op">=</span> ServiceDeps(</span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a>            db<span class="op">=</span>db,</span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">=</span>cache,</span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a>            event_bus<span class="op">=</span>event_bus,</span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>{<span class="st">"environment"</span>: <span class="st">"production"</span>}</span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create and start service</span></span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a>        service <span class="op">=</span> UserManagementService(deps)</span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.start_server()</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a>    asyncio.run(main())</span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing</span></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.testing <span class="im">import</span> create_test_client</span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span></span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_deps():</span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create test dependencies with mocks."""</span></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ServiceDeps(</span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a>        db<span class="op">=</span>MockDatabase(),</span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">=</span>MockCache(),</span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>        event_bus<span class="op">=</span>MockEventBus(),</span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>{<span class="st">"environment"</span>: <span class="st">"test"</span>}</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_user_registration(test_deps):</span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> UserManagementService(test_deps)</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a>    user_data <span class="op">=</span> UserCreate(</span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a>        email<span class="op">=</span><span class="st">"test@example.com"</span>,</span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a>        password<span class="op">=</span><span class="st">"securepass123"</span>,</span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a>        full_name<span class="op">=</span><span class="st">"Test User"</span></span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> <span class="cf">await</span> service.create_user(user_data)</span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.email <span class="op">==</span> <span class="st">"test@example.com"</span></span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.full_name <span class="op">==</span> <span class="st">"Test User"</span></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user.<span class="bu">id</span> <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_duplicate_email(test_deps):</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> UserManagementService(test_deps)</span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create first user</span></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a>    user_data <span class="op">=</span> UserCreate(</span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a>        email<span class="op">=</span><span class="st">"test@example.com"</span>,</span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a>        password<span class="op">=</span><span class="st">"securepass123"</span>,</span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a>        full_name<span class="op">=</span><span class="st">"Test User"</span></span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-353"><a href="#cb18-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> service.create_user(user_data)</span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to create with same email</span></span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>, match<span class="op">=</span><span class="st">"already registered"</span>):</span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.create_user(user_data)</span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a><span class="fu">### Deployment</span></span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a><span class="in">```yaml</span></span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.yml</span></span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.8'</span></span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">user-service</span><span class="kw">:</span></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">"8000:8000"</span></span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>DATABASE_URL=postgresql://postgres:password@db/users</span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>REDIS_URL=redis://redis:6379</span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>db</span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>redis</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">db</span><span class="kw">:</span></span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:15</span></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>POSTGRES_DB=users</span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>POSTGRES_PASSWORD=password</span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>postgres_data:/var/lib/postgresql/data</span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">redis</span><span class="kw">:</span></span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> redis:7-alpine</span></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span>redis_data:/data</span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">postgres_data</span><span class="kw">:</span></span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">redis_data</span><span class="kw">:</span></span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example 2: Real-time Data Processing Pipeline</span></span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a>A production data pipeline that processes streaming data with validation, transformation, and storage.</span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a><span class="fu">### Architecture</span></span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb18-406"><a href="#cb18-406" aria-hidden="true" tabindex="-1"></a>    A[Kafka Stream] --&gt; B[Message Consumer]</span>
<span id="cb18-407"><a href="#cb18-407" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Schema Validator]</span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Data Enricher]</span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a>    D --&gt; E[Business Rules]</span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a>    E --&gt; F{Router}</span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a>    F --&gt;|Type A| G[Processor A]</span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a>    F --&gt;|Type B| H[Processor B]</span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a>    G --&gt; I[Aggregator]</span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a>    H --&gt; I</span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a>    I --&gt; J[Data Lake]</span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a>    I --&gt; K[Analytics DB]</span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a>    I --&gt; L[Real-<span class="fu">time</span> Dashboard]</span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> NanobrickBase, Nanobrick, create_pipeline</span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Router, Parallel, Window</span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Any</span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiokafka</span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-431"><a href="#cb18-431" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb18-432"><a href="#cb18-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-433"><a href="#cb18-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Data models</span></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SensorReading(BaseModel):</span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a>    sensor_id: <span class="bu">str</span></span>
<span id="cb18-436"><a href="#cb18-436" aria-hidden="true" tabindex="-1"></a>    timestamp: datetime</span>
<span id="cb18-437"><a href="#cb18-437" aria-hidden="true" tabindex="-1"></a>    temperature: <span class="bu">float</span></span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a>    humidity: <span class="bu">float</span></span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a>    location: Dict[<span class="bu">str</span>, <span class="bu">float</span>]  <span class="co"># lat, lon</span></span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnrichedReading(SensorReading):</span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a>    city: <span class="bu">str</span></span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a>    country: <span class="bu">str</span></span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a>    weather_conditions: <span class="bu">str</span></span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a>    anomaly_score: <span class="bu">float</span></span>
<span id="cb18-446"><a href="#cb18-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-447"><a href="#cb18-447" aria-hidden="true" tabindex="-1"></a><span class="co"># Processing bricks</span></span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidateSensorData(Nanobrick[Dict, SensorReading]):</span>
<span id="cb18-449"><a href="#cb18-449" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validates and parses raw sensor data."""</span></span>
<span id="cb18-450"><a href="#cb18-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, raw_data: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> SensorReading:</span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a>            reading <span class="op">=</span> SensorReading(<span class="op">**</span>raw_data)</span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Validate ranges</span></span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="op">-</span><span class="dv">50</span> <span class="op">&lt;=</span> reading.temperature <span class="op">&lt;=</span> <span class="dv">70</span>:</span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid temperature: </span><span class="sc">{</span>reading<span class="sc">.</span>temperature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-458"><a href="#cb18-458" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-459"><a href="#cb18-459" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="dv">0</span> <span class="op">&lt;=</span> reading.humidity <span class="op">&lt;=</span> <span class="dv">100</span>:</span>
<span id="cb18-460"><a href="#cb18-460" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid humidity: </span><span class="sc">{</span>reading<span class="sc">.</span>humidity<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-461"><a href="#cb18-461" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-462"><a href="#cb18-462" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> reading</span>
<span id="cb18-463"><a href="#cb18-463" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-464"><a href="#cb18-464" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-465"><a href="#cb18-465" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log to dead letter queue</span></span>
<span id="cb18-466"><a href="#cb18-466" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid sensor data: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-467"><a href="#cb18-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-468"><a href="#cb18-468" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnrichWithLocation(NanobrickBase[SensorReading, EnrichedReading, ServiceDeps]):</span>
<span id="cb18-469"><a href="#cb18-469" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Enriches reading with location data."""</span></span>
<span id="cb18-470"><a href="#cb18-470" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-471"><a href="#cb18-471" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, reading: SensorReading, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> EnrichedReading:</span>
<span id="cb18-472"><a href="#cb18-472" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get location from cache or API</span></span>
<span id="cb18-473"><a href="#cb18-473" aria-hidden="true" tabindex="-1"></a>        location_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>reading<span class="sc">.</span>location[<span class="st">'lat'</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>reading<span class="sc">.</span>location[<span class="st">'lon'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-474"><a href="#cb18-474" aria-hidden="true" tabindex="-1"></a>        location_data <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"cache"</span>].get(location_key)</span>
<span id="cb18-475"><a href="#cb18-475" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-476"><a href="#cb18-476" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> location_data:</span>
<span id="cb18-477"><a href="#cb18-477" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Call geocoding API</span></span>
<span id="cb18-478"><a href="#cb18-478" aria-hidden="true" tabindex="-1"></a>            location_data <span class="op">=</span> <span class="cf">await</span> deps[<span class="st">"geocoding_api"</span>].reverse_geocode(</span>
<span id="cb18-479"><a href="#cb18-479" aria-hidden="true" tabindex="-1"></a>                reading.location[<span class="st">'lat'</span>],</span>
<span id="cb18-480"><a href="#cb18-480" aria-hidden="true" tabindex="-1"></a>                reading.location[<span class="st">'lon'</span>]</span>
<span id="cb18-481"><a href="#cb18-481" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-482"><a href="#cb18-482" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"cache"</span>].setex(location_key, <span class="dv">86400</span>, location_data)</span>
<span id="cb18-483"><a href="#cb18-483" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-484"><a href="#cb18-484" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EnrichedReading(</span>
<span id="cb18-485"><a href="#cb18-485" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>reading.<span class="bu">dict</span>(),</span>
<span id="cb18-486"><a href="#cb18-486" aria-hidden="true" tabindex="-1"></a>            city<span class="op">=</span>location_data[<span class="st">'city'</span>],</span>
<span id="cb18-487"><a href="#cb18-487" aria-hidden="true" tabindex="-1"></a>            country<span class="op">=</span>location_data[<span class="st">'country'</span>],</span>
<span id="cb18-488"><a href="#cb18-488" aria-hidden="true" tabindex="-1"></a>            weather_conditions<span class="op">=</span><span class="st">"normal"</span>,  <span class="co"># Would call weather API</span></span>
<span id="cb18-489"><a href="#cb18-489" aria-hidden="true" tabindex="-1"></a>            anomaly_score<span class="op">=</span><span class="fl">0.0</span></span>
<span id="cb18-490"><a href="#cb18-490" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-491"><a href="#cb18-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-492"><a href="#cb18-492" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DetectAnomalies(NanobrickBase[EnrichedReading, EnrichedReading, ServiceDeps]):</span>
<span id="cb18-493"><a href="#cb18-493" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Detects anomalies using ML model."""</span></span>
<span id="cb18-494"><a href="#cb18-494" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-495"><a href="#cb18-495" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, reading: EnrichedReading, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> EnrichedReading:</span>
<span id="cb18-496"><a href="#cb18-496" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use pre-trained model</span></span>
<span id="cb18-497"><a href="#cb18-497" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> deps[<span class="st">"ml_models"</span>][<span class="st">"anomaly_detector"</span>]</span>
<span id="cb18-498"><a href="#cb18-498" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-499"><a href="#cb18-499" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [</span>
<span id="cb18-500"><a href="#cb18-500" aria-hidden="true" tabindex="-1"></a>            reading.temperature,</span>
<span id="cb18-501"><a href="#cb18-501" aria-hidden="true" tabindex="-1"></a>            reading.humidity,</span>
<span id="cb18-502"><a href="#cb18-502" aria-hidden="true" tabindex="-1"></a>            reading.timestamp.hour,</span>
<span id="cb18-503"><a href="#cb18-503" aria-hidden="true" tabindex="-1"></a>            reading.timestamp.weekday()</span>
<span id="cb18-504"><a href="#cb18-504" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-505"><a href="#cb18-505" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-506"><a href="#cb18-506" aria-hidden="true" tabindex="-1"></a>        anomaly_score <span class="op">=</span> model.predict_proba([features])[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb18-507"><a href="#cb18-507" aria-hidden="true" tabindex="-1"></a>        reading.anomaly_score <span class="op">=</span> <span class="bu">float</span>(anomaly_score)</span>
<span id="cb18-508"><a href="#cb18-508" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-509"><a href="#cb18-509" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> anomaly_score <span class="op">&gt;</span> <span class="fl">0.8</span>:</span>
<span id="cb18-510"><a href="#cb18-510" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Trigger alert</span></span>
<span id="cb18-511"><a href="#cb18-511" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"event_bus"</span>].emit(<span class="st">"anomaly.detected"</span>, {</span>
<span id="cb18-512"><a href="#cb18-512" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sensor_id"</span>: reading.sensor_id,</span>
<span id="cb18-513"><a href="#cb18-513" aria-hidden="true" tabindex="-1"></a>                <span class="st">"score"</span>: anomaly_score,</span>
<span id="cb18-514"><a href="#cb18-514" aria-hidden="true" tabindex="-1"></a>                <span class="st">"reading"</span>: reading.<span class="bu">dict</span>()</span>
<span id="cb18-515"><a href="#cb18-515" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb18-516"><a href="#cb18-516" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-517"><a href="#cb18-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> reading</span>
<span id="cb18-518"><a href="#cb18-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-519"><a href="#cb18-519" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AggregateReadings(Nanobrick[List[EnrichedReading], Dict]):</span>
<span id="cb18-520"><a href="#cb18-520" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Aggregates readings for analytics."""</span></span>
<span id="cb18-521"><a href="#cb18-521" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-522"><a href="#cb18-522" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, readings: List[EnrichedReading], <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-523"><a href="#cb18-523" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame([r.<span class="bu">dict</span>() <span class="cf">for</span> r <span class="kw">in</span> readings])</span>
<span id="cb18-524"><a href="#cb18-524" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-525"><a href="#cb18-525" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb18-526"><a href="#cb18-526" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: datetime.utcnow(),</span>
<span id="cb18-527"><a href="#cb18-527" aria-hidden="true" tabindex="-1"></a>            <span class="st">"count"</span>: <span class="bu">len</span>(readings),</span>
<span id="cb18-528"><a href="#cb18-528" aria-hidden="true" tabindex="-1"></a>            <span class="st">"avg_temperature"</span>: df[<span class="st">'temperature'</span>].mean(),</span>
<span id="cb18-529"><a href="#cb18-529" aria-hidden="true" tabindex="-1"></a>            <span class="st">"avg_humidity"</span>: df[<span class="st">'humidity'</span>].mean(),</span>
<span id="cb18-530"><a href="#cb18-530" aria-hidden="true" tabindex="-1"></a>            <span class="st">"anomaly_count"</span>: <span class="bu">len</span>(df[df[<span class="st">'anomaly_score'</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>]),</span>
<span id="cb18-531"><a href="#cb18-531" aria-hidden="true" tabindex="-1"></a>            <span class="st">"by_city"</span>: df.groupby(<span class="st">'city'</span>).agg({</span>
<span id="cb18-532"><a href="#cb18-532" aria-hidden="true" tabindex="-1"></a>                <span class="st">'temperature'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-533"><a href="#cb18-533" aria-hidden="true" tabindex="-1"></a>                <span class="st">'humidity'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-534"><a href="#cb18-534" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sensor_id'</span>: <span class="st">'count'</span></span>
<span id="cb18-535"><a href="#cb18-535" aria-hidden="true" tabindex="-1"></a>            }).to_dict()</span>
<span id="cb18-536"><a href="#cb18-536" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-537"><a href="#cb18-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-538"><a href="#cb18-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Create processing pipeline</span></span>
<span id="cb18-539"><a href="#cb18-539" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"monitoring"</span>, metrics<span class="op">=</span>[<span class="st">"throughput"</span>, <span class="st">"latency"</span>, <span class="st">"errors"</span>])</span>
<span id="cb18-540"><a href="#cb18-540" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"scaling"</span>, auto_scale<span class="op">=</span><span class="va">True</span>, min_instances<span class="op">=</span><span class="dv">2</span>, max_instances<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb18-541"><a href="#cb18-541" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SensorDataPipeline:</span>
<span id="cb18-542"><a href="#cb18-542" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Real-time sensor data processing pipeline."""</span></span>
<span id="cb18-543"><a href="#cb18-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-544"><a href="#cb18-544" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb18-545"><a href="#cb18-545" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb18-546"><a href="#cb18-546" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-547"><a href="#cb18-547" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Main processing pipeline</span></span>
<span id="cb18-548"><a href="#cb18-548" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.process_reading <span class="op">=</span> Pipeline(</span>
<span id="cb18-549"><a href="#cb18-549" aria-hidden="true" tabindex="-1"></a>            ValidateSensorData(),</span>
<span id="cb18-550"><a href="#cb18-550" aria-hidden="true" tabindex="-1"></a>            EnrichWithLocation(),</span>
<span id="cb18-551"><a href="#cb18-551" aria-hidden="true" tabindex="-1"></a>            DetectAnomalies()</span>
<span id="cb18-552"><a href="#cb18-552" aria-hidden="true" tabindex="-1"></a>        ).with_skill(<span class="st">"retry"</span>, max_attempts<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb18-553"><a href="#cb18-553" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-554"><a href="#cb18-554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Aggregation window</span></span>
<span id="cb18-555"><a href="#cb18-555" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.windowed_aggregation <span class="op">=</span> Window(</span>
<span id="cb18-556"><a href="#cb18-556" aria-hidden="true" tabindex="-1"></a>            window_size<span class="op">=</span>timedelta(minutes<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb18-557"><a href="#cb18-557" aria-hidden="true" tabindex="-1"></a>            aggregator<span class="op">=</span>AggregateReadings()</span>
<span id="cb18-558"><a href="#cb18-558" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-559"><a href="#cb18-559" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-560"><a href="#cb18-560" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Storage writers</span></span>
<span id="cb18-561"><a href="#cb18-561" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lake_writer <span class="op">=</span> DataLakeWriter()</span>
<span id="cb18-562"><a href="#cb18-562" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.analytics_writer <span class="op">=</span> AnalyticsDBWriter()</span>
<span id="cb18-563"><a href="#cb18-563" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dashboard_updater <span class="op">=</span> DashboardUpdater()</span>
<span id="cb18-564"><a href="#cb18-564" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-565"><a href="#cb18-565" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parallel output</span></span>
<span id="cb18-566"><a href="#cb18-566" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_handlers <span class="op">=</span> Parallel([</span>
<span id="cb18-567"><a href="#cb18-567" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lake_writer,</span>
<span id="cb18-568"><a href="#cb18-568" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.analytics_writer,</span>
<span id="cb18-569"><a href="#cb18-569" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dashboard_updater</span>
<span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> start(<span class="va">self</span>):</span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Start consuming from Kafka."""</span></span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a>        consumer <span class="op">=</span> aiokafka.AIOKafkaConsumer(</span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sensor-readings'</span>,</span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a>            bootstrap_servers<span class="op">=</span><span class="st">'localhost:9092'</span>,</span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a>            group_id<span class="op">=</span><span class="st">'sensor-processor'</span>,</span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a>            value_deserializer<span class="op">=</span><span class="kw">lambda</span> m: json.loads(m.decode(<span class="st">'utf-8'</span>))</span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> consumer.start()</span>
<span id="cb18-582"><a href="#cb18-582" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-583"><a href="#cb18-583" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a>            <span class="cf">async</span> <span class="cf">for</span> msg <span class="kw">in</span> consumer:</span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Process individual reading</span></span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a>                    reading <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.process_reading.invoke(</span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a>                        msg.value,</span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a>                        deps<span class="op">=</span><span class="va">self</span>.deps</span>
<span id="cb18-590"><a href="#cb18-590" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb18-591"><a href="#cb18-591" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add to aggregation window</span></span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="va">self</span>.windowed_aggregation.add(reading)</span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb18-595"><a href="#cb18-595" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if window is ready</span></span>
<span id="cb18-596"><a href="#cb18-596" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.windowed_aggregation.is_ready():</span>
<span id="cb18-597"><a href="#cb18-597" aria-hidden="true" tabindex="-1"></a>                        aggregated <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.windowed_aggregation.invoke()</span>
<span id="cb18-598"><a href="#cb18-598" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">await</span> <span class="va">self</span>.output_handlers.invoke(aggregated, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb18-599"><a href="#cb18-599" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb18-600"><a href="#cb18-600" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-601"><a href="#cb18-601" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Send to dead letter queue</span></span>
<span id="cb18-602"><a href="#cb18-602" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"dead_letter_queue"</span>].send({</span>
<span id="cb18-603"><a href="#cb18-603" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"error"</span>: <span class="bu">str</span>(e),</span>
<span id="cb18-604"><a href="#cb18-604" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"message"</span>: msg.value,</span>
<span id="cb18-605"><a href="#cb18-605" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb18-606"><a href="#cb18-606" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb18-607"><a href="#cb18-607" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb18-608"><a href="#cb18-608" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb18-609"><a href="#cb18-609" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> consumer.stop()</span>
<span id="cb18-610"><a href="#cb18-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-611"><a href="#cb18-611" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitoring and alerting</span></span>
<span id="cb18-612"><a href="#cb18-612" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PipelineMonitor(Nanobrick[Dict, <span class="va">None</span>]):</span>
<span id="cb18-613"><a href="#cb18-613" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Monitors pipeline health and sends alerts."""</span></span>
<span id="cb18-614"><a href="#cb18-614" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-615"><a href="#cb18-615" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, thresholds: Dict):</span>
<span id="cb18-616"><a href="#cb18-616" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb18-617"><a href="#cb18-617" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.thresholds <span class="op">=</span> thresholds</span>
<span id="cb18-618"><a href="#cb18-618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-619"><a href="#cb18-619" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, metrics: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb18-620"><a href="#cb18-620" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check error rate</span></span>
<span id="cb18-621"><a href="#cb18-621" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metrics[<span class="st">'error_rate'</span>] <span class="op">&gt;</span> <span class="va">self</span>.thresholds[<span class="st">'max_error_rate'</span>]:</span>
<span id="cb18-622"><a href="#cb18-622" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"alerting"</span>].send_alert(</span>
<span id="cb18-623"><a href="#cb18-623" aria-hidden="true" tabindex="-1"></a>                severity<span class="op">=</span><span class="st">"high"</span>,</span>
<span id="cb18-624"><a href="#cb18-624" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span><span class="ss">f"High error rate: </span><span class="sc">{</span>metrics[<span class="st">'error_rate'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>,</span>
<span id="cb18-625"><a href="#cb18-625" aria-hidden="true" tabindex="-1"></a>                runbook_url<span class="op">=</span><span class="st">"https://wiki/sensor-pipeline-errors"</span></span>
<span id="cb18-626"><a href="#cb18-626" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-627"><a href="#cb18-627" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-628"><a href="#cb18-628" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check latency</span></span>
<span id="cb18-629"><a href="#cb18-629" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metrics[<span class="st">'p99_latency'</span>] <span class="op">&gt;</span> <span class="va">self</span>.thresholds[<span class="st">'max_latency_ms'</span>]:</span>
<span id="cb18-630"><a href="#cb18-630" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"alerting"</span>].send_alert(</span>
<span id="cb18-631"><a href="#cb18-631" aria-hidden="true" tabindex="-1"></a>                severity<span class="op">=</span><span class="st">"medium"</span>,</span>
<span id="cb18-632"><a href="#cb18-632" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span><span class="ss">f"High latency: </span><span class="sc">{</span>metrics[<span class="st">'p99_latency'</span>]<span class="sc">}</span><span class="ss">ms"</span>,</span>
<span id="cb18-633"><a href="#cb18-633" aria-hidden="true" tabindex="-1"></a>                runbook_url<span class="op">=</span><span class="st">"https://wiki/sensor-pipeline-latency"</span></span>
<span id="cb18-634"><a href="#cb18-634" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-635"><a href="#cb18-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-636"><a href="#cb18-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-637"><a href="#cb18-637" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance Optimization</span></span>
<span id="cb18-638"><a href="#cb18-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-641"><a href="#cb18-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-642"><a href="#cb18-642" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-643"><a href="#cb18-643" aria-hidden="true" tabindex="-1"></a><span class="co"># Add performance optimizations</span></span>
<span id="cb18-644"><a href="#cb18-644" aria-hidden="true" tabindex="-1"></a>optimized_pipeline <span class="op">=</span> (</span>
<span id="cb18-645"><a href="#cb18-645" aria-hidden="true" tabindex="-1"></a>    SensorDataPipeline(deps)</span>
<span id="cb18-646"><a href="#cb18-646" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"cache"</span>, ttl<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb18-647"><a href="#cb18-647" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"batch"</span>, size<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb18-648"><a href="#cb18-648" aria-hidden="true" tabindex="-1"></a>    .with_skill(<span class="st">"profile"</span>, trace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-649"><a href="#cb18-649" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-650"><a href="#cb18-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-651"><a href="#cb18-651" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure for high throughput</span></span>
<span id="cb18-652"><a href="#cb18-652" aria-hidden="true" tabindex="-1"></a>high_throughput_config <span class="op">=</span> {</span>
<span id="cb18-653"><a href="#cb18-653" aria-hidden="true" tabindex="-1"></a>    <span class="st">"consumer"</span>: {</span>
<span id="cb18-654"><a href="#cb18-654" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fetch_min_bytes"</span>: <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>,  <span class="co"># 1MB</span></span>
<span id="cb18-655"><a href="#cb18-655" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_poll_records"</span>: <span class="dv">500</span></span>
<span id="cb18-656"><a href="#cb18-656" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-657"><a href="#cb18-657" aria-hidden="true" tabindex="-1"></a>    <span class="st">"processing"</span>: {</span>
<span id="cb18-658"><a href="#cb18-658" aria-hidden="true" tabindex="-1"></a>        <span class="st">"parallelism"</span>: <span class="dv">8</span>,</span>
<span id="cb18-659"><a href="#cb18-659" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_timeout_ms"</span>: <span class="dv">100</span></span>
<span id="cb18-660"><a href="#cb18-660" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-661"><a href="#cb18-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">"output"</span>: {</span>
<span id="cb18-662"><a href="#cb18-662" aria-hidden="true" tabindex="-1"></a>        <span class="st">"compression"</span>: <span class="st">"snappy"</span>,</span>
<span id="cb18-663"><a href="#cb18-663" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_size"</span>: <span class="dv">1000</span></span>
<span id="cb18-664"><a href="#cb18-664" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-665"><a href="#cb18-665" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-666"><a href="#cb18-666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-667"><a href="#cb18-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-668"><a href="#cb18-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example 3: E-commerce Order Processing System</span></span>
<span id="cb18-669"><a href="#cb18-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-670"><a href="#cb18-670" aria-hidden="true" tabindex="-1"></a>A complete order processing system with inventory management, payment processing, and fulfillment.</span>
<span id="cb18-671"><a href="#cb18-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-672"><a href="#cb18-672" aria-hidden="true" tabindex="-1"></a><span class="fu">### System Architecture</span></span>
<span id="cb18-673"><a href="#cb18-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-676"><a href="#cb18-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-677"><a href="#cb18-677" aria-hidden="true" tabindex="-1"></a>graph TB</span>
<span id="cb18-678"><a href="#cb18-678" aria-hidden="true" tabindex="-1"></a>    subgraph <span class="ot">"</span><span class="st">Order Service</span><span class="ot">"</span></span>
<span id="cb18-679"><a href="#cb18-679" aria-hidden="true" tabindex="-1"></a>        A[Order API] --&gt; B[Order Validator]</span>
<span id="cb18-680"><a href="#cb18-680" aria-hidden="true" tabindex="-1"></a>        B --&gt; C[Inventory Check]</span>
<span id="cb18-681"><a href="#cb18-681" aria-hidden="true" tabindex="-1"></a>        C --&gt; D[Price Calculator]</span>
<span id="cb18-682"><a href="#cb18-682" aria-hidden="true" tabindex="-1"></a>        D --&gt; E[Payment Processor]</span>
<span id="cb18-683"><a href="#cb18-683" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-684"><a href="#cb18-684" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-685"><a href="#cb18-685" aria-hidden="true" tabindex="-1"></a>    subgraph <span class="ot">"</span><span class="st">Inventory Service</span><span class="ot">"</span></span>
<span id="cb18-686"><a href="#cb18-686" aria-hidden="true" tabindex="-1"></a>        C --&gt; F[Stock Manager]</span>
<span id="cb18-687"><a href="#cb18-687" aria-hidden="true" tabindex="-1"></a>        F --&gt; G[Warehouse API]</span>
<span id="cb18-688"><a href="#cb18-688" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-689"><a href="#cb18-689" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-690"><a href="#cb18-690" aria-hidden="true" tabindex="-1"></a>    subgraph <span class="ot">"</span><span class="st">Payment Service</span><span class="ot">"</span></span>
<span id="cb18-691"><a href="#cb18-691" aria-hidden="true" tabindex="-1"></a>        E --&gt; H[Payment Gateway]</span>
<span id="cb18-692"><a href="#cb18-692" aria-hidden="true" tabindex="-1"></a>        H --&gt; I[Fraud Detection]</span>
<span id="cb18-693"><a href="#cb18-693" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-694"><a href="#cb18-694" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-695"><a href="#cb18-695" aria-hidden="true" tabindex="-1"></a>    subgraph <span class="ot">"</span><span class="st">Fulfillment Service</span><span class="ot">"</span></span>
<span id="cb18-696"><a href="#cb18-696" aria-hidden="true" tabindex="-1"></a>        E --&gt; J[Order Queue]</span>
<span id="cb18-697"><a href="#cb18-697" aria-hidden="true" tabindex="-1"></a>        J --&gt; K[Shipping Calculator]</span>
<span id="cb18-698"><a href="#cb18-698" aria-hidden="true" tabindex="-1"></a>        K --&gt; L[Label Generator]</span>
<span id="cb18-699"><a href="#cb18-699" aria-hidden="true" tabindex="-1"></a>        L --&gt; M[Tracking Service]</span>
<span id="cb18-700"><a href="#cb18-700" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-701"><a href="#cb18-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-702"><a href="#cb18-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-703"><a href="#cb18-703" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb18-704"><a href="#cb18-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-707"><a href="#cb18-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-708"><a href="#cb18-708" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-709"><a href="#cb18-709" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks <span class="im">import</span> create_microservice, NanobrickBase</span>
<span id="cb18-710"><a href="#cb18-710" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.patterns <span class="im">import</span> Saga, Compensate</span>
<span id="cb18-711"><a href="#cb18-711" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal</span>
<span id="cb18-712"><a href="#cb18-712" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stripe</span>
<span id="cb18-713"><a href="#cb18-713" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb18-714"><a href="#cb18-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-715"><a href="#cb18-715" aria-hidden="true" tabindex="-1"></a><span class="co"># Domain models</span></span>
<span id="cb18-716"><a href="#cb18-716" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderItem(BaseModel):</span>
<span id="cb18-717"><a href="#cb18-717" aria-hidden="true" tabindex="-1"></a>    product_id: <span class="bu">str</span></span>
<span id="cb18-718"><a href="#cb18-718" aria-hidden="true" tabindex="-1"></a>    quantity: <span class="bu">int</span></span>
<span id="cb18-719"><a href="#cb18-719" aria-hidden="true" tabindex="-1"></a>    unit_price: Decimal</span>
<span id="cb18-720"><a href="#cb18-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-721"><a href="#cb18-721" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Order(BaseModel):</span>
<span id="cb18-722"><a href="#cb18-722" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span>: <span class="bu">str</span></span>
<span id="cb18-723"><a href="#cb18-723" aria-hidden="true" tabindex="-1"></a>    customer_id: <span class="bu">str</span></span>
<span id="cb18-724"><a href="#cb18-724" aria-hidden="true" tabindex="-1"></a>    items: List[OrderItem]</span>
<span id="cb18-725"><a href="#cb18-725" aria-hidden="true" tabindex="-1"></a>    shipping_address: Dict</span>
<span id="cb18-726"><a href="#cb18-726" aria-hidden="true" tabindex="-1"></a>    total: Decimal <span class="op">=</span> Decimal(<span class="st">"0"</span>)</span>
<span id="cb18-727"><a href="#cb18-727" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span> <span class="op">=</span> <span class="st">"pending"</span></span>
<span id="cb18-728"><a href="#cb18-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-729"><a href="#cb18-729" aria-hidden="true" tabindex="-1"></a><span class="co"># Inventory management</span></span>
<span id="cb18-730"><a href="#cb18-730" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckInventory(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb18-731"><a href="#cb18-731" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Checks and reserves inventory."""</span></span>
<span id="cb18-732"><a href="#cb18-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-733"><a href="#cb18-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb18-734"><a href="#cb18-734" aria-hidden="true" tabindex="-1"></a>        inventory_service <span class="op">=</span> deps[<span class="st">"inventory_service"</span>]</span>
<span id="cb18-735"><a href="#cb18-735" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-736"><a href="#cb18-736" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check availability for all items</span></span>
<span id="cb18-737"><a href="#cb18-737" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> order.items:</span>
<span id="cb18-738"><a href="#cb18-738" aria-hidden="true" tabindex="-1"></a>            available <span class="op">=</span> <span class="cf">await</span> inventory_service.check_stock(</span>
<span id="cb18-739"><a href="#cb18-739" aria-hidden="true" tabindex="-1"></a>                item.product_id,</span>
<span id="cb18-740"><a href="#cb18-740" aria-hidden="true" tabindex="-1"></a>                item.quantity</span>
<span id="cb18-741"><a href="#cb18-741" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-742"><a href="#cb18-742" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-743"><a href="#cb18-743" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> available:</span>
<span id="cb18-744"><a href="#cb18-744" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb18-745"><a href="#cb18-745" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Insufficient stock for product </span><span class="sc">{</span>item<span class="sc">.</span>product_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-746"><a href="#cb18-746" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb18-747"><a href="#cb18-747" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-748"><a href="#cb18-748" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reserve inventory</span></span>
<span id="cb18-749"><a href="#cb18-749" aria-hidden="true" tabindex="-1"></a>        reservation_id <span class="op">=</span> <span class="cf">await</span> inventory_service.reserve_items(</span>
<span id="cb18-750"><a href="#cb18-750" aria-hidden="true" tabindex="-1"></a>            [(item.product_id, item.quantity) <span class="cf">for</span> item <span class="kw">in</span> order.items],</span>
<span id="cb18-751"><a href="#cb18-751" aria-hidden="true" tabindex="-1"></a>            duration_minutes<span class="op">=</span><span class="dv">30</span>  <span class="co"># 30 minute reservation</span></span>
<span id="cb18-752"><a href="#cb18-752" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-753"><a href="#cb18-753" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-754"><a href="#cb18-754" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store reservation ID for potential rollback</span></span>
<span id="cb18-755"><a href="#cb18-755" aria-hidden="true" tabindex="-1"></a>        order.metadata <span class="op">=</span> {<span class="st">"reservation_id"</span>: reservation_id}</span>
<span id="cb18-756"><a href="#cb18-756" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-757"><a href="#cb18-757" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb18-758"><a href="#cb18-758" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-759"><a href="#cb18-759" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> compensate(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb18-760"><a href="#cb18-760" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Release inventory reservation on failure."""</span></span>
<span id="cb18-761"><a href="#cb18-761" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> reservation_id <span class="op">:=</span> order.metadata.get(<span class="st">"reservation_id"</span>):</span>
<span id="cb18-762"><a href="#cb18-762" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> deps[<span class="st">"inventory_service"</span>].release_reservation(reservation_id)</span>
<span id="cb18-763"><a href="#cb18-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-764"><a href="#cb18-764" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CalculatePricing(Nanobrick[Order, Order]):</span>
<span id="cb18-765"><a href="#cb18-765" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculates order total with taxes and discounts."""</span></span>
<span id="cb18-766"><a href="#cb18-766" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-767"><a href="#cb18-767" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, tax_rate: Decimal <span class="op">=</span> Decimal(<span class="st">"0.08"</span>)):</span>
<span id="cb18-768"><a href="#cb18-768" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb18-769"><a href="#cb18-769" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tax_rate <span class="op">=</span> tax_rate</span>
<span id="cb18-770"><a href="#cb18-770" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-771"><a href="#cb18-771" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Order:</span>
<span id="cb18-772"><a href="#cb18-772" aria-hidden="true" tabindex="-1"></a>        subtotal <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb18-773"><a href="#cb18-773" aria-hidden="true" tabindex="-1"></a>            item.quantity <span class="op">*</span> item.unit_price </span>
<span id="cb18-774"><a href="#cb18-774" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> order.items</span>
<span id="cb18-775"><a href="#cb18-775" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-776"><a href="#cb18-776" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-777"><a href="#cb18-777" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply discounts</span></span>
<span id="cb18-778"><a href="#cb18-778" aria-hidden="true" tabindex="-1"></a>        discount <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.calculate_discount(order, subtotal)</span>
<span id="cb18-779"><a href="#cb18-779" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-780"><a href="#cb18-780" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate tax</span></span>
<span id="cb18-781"><a href="#cb18-781" aria-hidden="true" tabindex="-1"></a>        taxable_amount <span class="op">=</span> subtotal <span class="op">-</span> discount</span>
<span id="cb18-782"><a href="#cb18-782" aria-hidden="true" tabindex="-1"></a>        tax <span class="op">=</span> taxable_amount <span class="op">*</span> <span class="va">self</span>.tax_rate</span>
<span id="cb18-783"><a href="#cb18-783" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-784"><a href="#cb18-784" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add shipping</span></span>
<span id="cb18-785"><a href="#cb18-785" aria-hidden="true" tabindex="-1"></a>        shipping <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.calculate_shipping(order)</span>
<span id="cb18-786"><a href="#cb18-786" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-787"><a href="#cb18-787" aria-hidden="true" tabindex="-1"></a>        order.total <span class="op">=</span> taxable_amount <span class="op">+</span> tax <span class="op">+</span> shipping</span>
<span id="cb18-788"><a href="#cb18-788" aria-hidden="true" tabindex="-1"></a>        order.breakdown <span class="op">=</span> {</span>
<span id="cb18-789"><a href="#cb18-789" aria-hidden="true" tabindex="-1"></a>            <span class="st">"subtotal"</span>: subtotal,</span>
<span id="cb18-790"><a href="#cb18-790" aria-hidden="true" tabindex="-1"></a>            <span class="st">"discount"</span>: discount,</span>
<span id="cb18-791"><a href="#cb18-791" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tax"</span>: tax,</span>
<span id="cb18-792"><a href="#cb18-792" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping"</span>: shipping,</span>
<span id="cb18-793"><a href="#cb18-793" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total"</span>: order.total</span>
<span id="cb18-794"><a href="#cb18-794" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-795"><a href="#cb18-795" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-796"><a href="#cb18-796" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb18-797"><a href="#cb18-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-798"><a href="#cb18-798" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessPayment(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb18-799"><a href="#cb18-799" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Processes payment through payment gateway."""</span></span>
<span id="cb18-800"><a href="#cb18-800" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-801"><a href="#cb18-801" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb18-802"><a href="#cb18-802" aria-hidden="true" tabindex="-1"></a>        stripe.api_key <span class="op">=</span> deps[<span class="st">"config"</span>][<span class="st">"stripe_api_key"</span>]</span>
<span id="cb18-803"><a href="#cb18-803" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-804"><a href="#cb18-804" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb18-805"><a href="#cb18-805" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create payment intent</span></span>
<span id="cb18-806"><a href="#cb18-806" aria-hidden="true" tabindex="-1"></a>            intent <span class="op">=</span> stripe.PaymentIntent.create(</span>
<span id="cb18-807"><a href="#cb18-807" aria-hidden="true" tabindex="-1"></a>                amount<span class="op">=</span><span class="bu">int</span>(order.total <span class="op">*</span> <span class="dv">100</span>),  <span class="co"># Convert to cents</span></span>
<span id="cb18-808"><a href="#cb18-808" aria-hidden="true" tabindex="-1"></a>                currency<span class="op">=</span><span class="st">"usd"</span>,</span>
<span id="cb18-809"><a href="#cb18-809" aria-hidden="true" tabindex="-1"></a>                customer<span class="op">=</span>order.customer_id,</span>
<span id="cb18-810"><a href="#cb18-810" aria-hidden="true" tabindex="-1"></a>                metadata<span class="op">=</span>{</span>
<span id="cb18-811"><a href="#cb18-811" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"order_id"</span>: order.<span class="bu">id</span></span>
<span id="cb18-812"><a href="#cb18-812" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb18-813"><a href="#cb18-813" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-814"><a href="#cb18-814" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-815"><a href="#cb18-815" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process payment</span></span>
<span id="cb18-816"><a href="#cb18-816" aria-hidden="true" tabindex="-1"></a>            payment <span class="op">=</span> stripe.PaymentIntent.confirm(</span>
<span id="cb18-817"><a href="#cb18-817" aria-hidden="true" tabindex="-1"></a>                intent.<span class="bu">id</span>,</span>
<span id="cb18-818"><a href="#cb18-818" aria-hidden="true" tabindex="-1"></a>                payment_method<span class="op">=</span>order.payment_method_id</span>
<span id="cb18-819"><a href="#cb18-819" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-820"><a href="#cb18-820" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-821"><a href="#cb18-821" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> payment.status <span class="op">==</span> <span class="st">"succeeded"</span>:</span>
<span id="cb18-822"><a href="#cb18-822" aria-hidden="true" tabindex="-1"></a>                order.status <span class="op">=</span> <span class="st">"paid"</span></span>
<span id="cb18-823"><a href="#cb18-823" aria-hidden="true" tabindex="-1"></a>                order.payment_id <span class="op">=</span> payment.<span class="bu">id</span></span>
<span id="cb18-824"><a href="#cb18-824" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb18-825"><a href="#cb18-825" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Payment failed: </span><span class="sc">{</span>payment<span class="sc">.</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-826"><a href="#cb18-826" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-827"><a href="#cb18-827" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> stripe.error.CardError <span class="im">as</span> e:</span>
<span id="cb18-828"><a href="#cb18-828" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Card declined: </span><span class="sc">{</span>e<span class="sc">.</span>user_message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-829"><a href="#cb18-829" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-830"><a href="#cb18-830" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb18-831"><a href="#cb18-831" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-832"><a href="#cb18-832" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> compensate(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb18-833"><a href="#cb18-833" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Refund payment on failure."""</span></span>
<span id="cb18-834"><a href="#cb18-834" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> payment_id <span class="op">:=</span> <span class="bu">getattr</span>(order, <span class="st">"payment_id"</span>, <span class="va">None</span>):</span>
<span id="cb18-835"><a href="#cb18-835" aria-hidden="true" tabindex="-1"></a>            stripe.Refund.create(payment_intent<span class="op">=</span>payment_id)</span>
<span id="cb18-836"><a href="#cb18-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-837"><a href="#cb18-837" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreateFulfillment(NanobrickBase[Order, Order, ServiceDeps]):</span>
<span id="cb18-838"><a href="#cb18-838" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates fulfillment order for shipping."""</span></span>
<span id="cb18-839"><a href="#cb18-839" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-840"><a href="#cb18-840" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, order: Order, <span class="op">*</span>, deps: ServiceDeps) <span class="op">-&gt;</span> Order:</span>
<span id="cb18-841"><a href="#cb18-841" aria-hidden="true" tabindex="-1"></a>        fulfillment_service <span class="op">=</span> deps[<span class="st">"fulfillment_service"</span>]</span>
<span id="cb18-842"><a href="#cb18-842" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-843"><a href="#cb18-843" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate shipping options</span></span>
<span id="cb18-844"><a href="#cb18-844" aria-hidden="true" tabindex="-1"></a>        shipping_options <span class="op">=</span> <span class="cf">await</span> fulfillment_service.calculate_shipping(</span>
<span id="cb18-845"><a href="#cb18-845" aria-hidden="true" tabindex="-1"></a>            items<span class="op">=</span>order.items,</span>
<span id="cb18-846"><a href="#cb18-846" aria-hidden="true" tabindex="-1"></a>            destination<span class="op">=</span>order.shipping_address</span>
<span id="cb18-847"><a href="#cb18-847" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-848"><a href="#cb18-848" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-849"><a href="#cb18-849" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select best option (could be user preference)</span></span>
<span id="cb18-850"><a href="#cb18-850" aria-hidden="true" tabindex="-1"></a>        selected_option <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb18-851"><a href="#cb18-851" aria-hidden="true" tabindex="-1"></a>            shipping_options,</span>
<span id="cb18-852"><a href="#cb18-852" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"cost"</span>] <span class="op">+</span> x[<span class="st">"days"</span>] <span class="op">*</span> <span class="dv">5</span>  <span class="co"># Balance cost and speed</span></span>
<span id="cb18-853"><a href="#cb18-853" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-854"><a href="#cb18-854" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-855"><a href="#cb18-855" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create fulfillment order</span></span>
<span id="cb18-856"><a href="#cb18-856" aria-hidden="true" tabindex="-1"></a>        fulfillment <span class="op">=</span> <span class="cf">await</span> fulfillment_service.create_order({</span>
<span id="cb18-857"><a href="#cb18-857" aria-hidden="true" tabindex="-1"></a>            <span class="st">"order_id"</span>: order.<span class="bu">id</span>,</span>
<span id="cb18-858"><a href="#cb18-858" aria-hidden="true" tabindex="-1"></a>            <span class="st">"items"</span>: order.items,</span>
<span id="cb18-859"><a href="#cb18-859" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping_address"</span>: order.shipping_address,</span>
<span id="cb18-860"><a href="#cb18-860" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shipping_method"</span>: selected_option[<span class="st">"method"</span>],</span>
<span id="cb18-861"><a href="#cb18-861" aria-hidden="true" tabindex="-1"></a>            <span class="st">"expected_delivery"</span>: selected_option[<span class="st">"estimated_delivery"</span>]</span>
<span id="cb18-862"><a href="#cb18-862" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb18-863"><a href="#cb18-863" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-864"><a href="#cb18-864" aria-hidden="true" tabindex="-1"></a>        order.fulfillment_id <span class="op">=</span> fulfillment[<span class="st">"id"</span>]</span>
<span id="cb18-865"><a href="#cb18-865" aria-hidden="true" tabindex="-1"></a>        order.tracking_number <span class="op">=</span> fulfillment[<span class="st">"tracking_number"</span>]</span>
<span id="cb18-866"><a href="#cb18-866" aria-hidden="true" tabindex="-1"></a>        order.status <span class="op">=</span> <span class="st">"processing"</span></span>
<span id="cb18-867"><a href="#cb18-867" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-868"><a href="#cb18-868" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> order</span>
<span id="cb18-869"><a href="#cb18-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-870"><a href="#cb18-870" aria-hidden="true" tabindex="-1"></a><span class="co"># Create order processing saga</span></span>
<span id="cb18-871"><a href="#cb18-871" aria-hidden="true" tabindex="-1"></a>order_saga <span class="op">=</span> Saga(</span>
<span id="cb18-872"><a href="#cb18-872" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"order_processing"</span>,</span>
<span id="cb18-873"><a href="#cb18-873" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb18-874"><a href="#cb18-874" aria-hidden="true" tabindex="-1"></a>        CheckInventory(),</span>
<span id="cb18-875"><a href="#cb18-875" aria-hidden="true" tabindex="-1"></a>        CalculatePricing(),</span>
<span id="cb18-876"><a href="#cb18-876" aria-hidden="true" tabindex="-1"></a>        ProcessPayment(),</span>
<span id="cb18-877"><a href="#cb18-877" aria-hidden="true" tabindex="-1"></a>        CreateFulfillment()</span>
<span id="cb18-878"><a href="#cb18-878" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb18-879"><a href="#cb18-879" aria-hidden="true" tabindex="-1"></a>    compensation_strategy<span class="op">=</span><span class="st">"reverse"</span>  <span class="co"># Compensate in reverse order</span></span>
<span id="cb18-880"><a href="#cb18-880" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"monitoring"</span>, track_compensation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-881"><a href="#cb18-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-882"><a href="#cb18-882" aria-hidden="true" tabindex="-1"></a><span class="co"># Order service with event sourcing</span></span>
<span id="cb18-883"><a href="#cb18-883" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"api"</span>, port<span class="op">=</span><span class="dv">8001</span>)</span>
<span id="cb18-884"><a href="#cb18-884" aria-hidden="true" tabindex="-1"></a><span class="at">@skill</span>(<span class="st">"event_sourcing"</span>, store<span class="op">=</span><span class="st">"postgresql"</span>)</span>
<span id="cb18-885"><a href="#cb18-885" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderProcessingService:</span>
<span id="cb18-886"><a href="#cb18-886" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete order processing service."""</span></span>
<span id="cb18-887"><a href="#cb18-887" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-888"><a href="#cb18-888" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, deps: ServiceDeps):</span>
<span id="cb18-889"><a href="#cb18-889" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> deps</span>
<span id="cb18-890"><a href="#cb18-890" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.saga <span class="op">=</span> order_saga</span>
<span id="cb18-891"><a href="#cb18-891" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-892"><a href="#cb18-892" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event handlers for async processing</span></span>
<span id="cb18-893"><a href="#cb18-893" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.event_handlers <span class="op">=</span> {</span>
<span id="cb18-894"><a href="#cb18-894" aria-hidden="true" tabindex="-1"></a>            <span class="st">"order.created"</span>: <span class="va">self</span>.handle_order_created,</span>
<span id="cb18-895"><a href="#cb18-895" aria-hidden="true" tabindex="-1"></a>            <span class="st">"payment.completed"</span>: <span class="va">self</span>.handle_payment_completed,</span>
<span id="cb18-896"><a href="#cb18-896" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fulfillment.shipped"</span>: <span class="va">self</span>.handle_order_shipped</span>
<span id="cb18-897"><a href="#cb18-897" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-898"><a href="#cb18-898" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-899"><a href="#cb18-899" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create_order(<span class="va">self</span>, order_data: Dict) <span class="op">-&gt;</span> Order:</span>
<span id="cb18-900"><a href="#cb18-900" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""POST /orders - Create new order"""</span></span>
<span id="cb18-901"><a href="#cb18-901" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> Order(<span class="op">**</span>order_data)</span>
<span id="cb18-902"><a href="#cb18-902" aria-hidden="true" tabindex="-1"></a>        order.<span class="bu">id</span> <span class="op">=</span> generate_order_id()</span>
<span id="cb18-903"><a href="#cb18-903" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-904"><a href="#cb18-904" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb18-905"><a href="#cb18-905" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process through saga</span></span>
<span id="cb18-906"><a href="#cb18-906" aria-hidden="true" tabindex="-1"></a>            processed_order <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.saga.invoke(order, deps<span class="op">=</span><span class="va">self</span>.deps)</span>
<span id="cb18-907"><a href="#cb18-907" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-908"><a href="#cb18-908" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Emit success event</span></span>
<span id="cb18-909"><a href="#cb18-909" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"event_bus"</span>].emit(<span class="st">"order.completed"</span>, {</span>
<span id="cb18-910"><a href="#cb18-910" aria-hidden="true" tabindex="-1"></a>                <span class="st">"order"</span>: processed_order.<span class="bu">dict</span>(),</span>
<span id="cb18-911"><a href="#cb18-911" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb18-912"><a href="#cb18-912" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb18-913"><a href="#cb18-913" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-914"><a href="#cb18-914" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> processed_order</span>
<span id="cb18-915"><a href="#cb18-915" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-916"><a href="#cb18-916" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-917"><a href="#cb18-917" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Saga will handle compensation</span></span>
<span id="cb18-918"><a href="#cb18-918" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"event_bus"</span>].emit(<span class="st">"order.failed"</span>, {</span>
<span id="cb18-919"><a href="#cb18-919" aria-hidden="true" tabindex="-1"></a>                <span class="st">"order_id"</span>: order.<span class="bu">id</span>,</span>
<span id="cb18-920"><a href="#cb18-920" aria-hidden="true" tabindex="-1"></a>                <span class="st">"error"</span>: <span class="bu">str</span>(e),</span>
<span id="cb18-921"><a href="#cb18-921" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp"</span>: datetime.utcnow()</span>
<span id="cb18-922"><a href="#cb18-922" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb18-923"><a href="#cb18-923" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb18-924"><a href="#cb18-924" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-925"><a href="#cb18-925" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> handle_order_shipped(<span class="va">self</span>, event: Dict):</span>
<span id="cb18-926"><a href="#cb18-926" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Handle shipment notification."""</span></span>
<span id="cb18-927"><a href="#cb18-927" aria-hidden="true" tabindex="-1"></a>        order_id <span class="op">=</span> event[<span class="st">"order_id"</span>]</span>
<span id="cb18-928"><a href="#cb18-928" aria-hidden="true" tabindex="-1"></a>        tracking_info <span class="op">=</span> event[<span class="st">"tracking_info"</span>]</span>
<span id="cb18-929"><a href="#cb18-929" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-930"><a href="#cb18-930" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update order status</span></span>
<span id="cb18-931"><a href="#cb18-931" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"db"</span>].execute(<span class="st">"""</span></span>
<span id="cb18-932"><a href="#cb18-932" aria-hidden="true" tabindex="-1"></a><span class="st">            UPDATE orders </span></span>
<span id="cb18-933"><a href="#cb18-933" aria-hidden="true" tabindex="-1"></a><span class="st">            SET status = 'shipped',</span></span>
<span id="cb18-934"><a href="#cb18-934" aria-hidden="true" tabindex="-1"></a><span class="st">                tracking_number = $1,</span></span>
<span id="cb18-935"><a href="#cb18-935" aria-hidden="true" tabindex="-1"></a><span class="st">                shipped_at = $2</span></span>
<span id="cb18-936"><a href="#cb18-936" aria-hidden="true" tabindex="-1"></a><span class="st">            WHERE id = $3</span></span>
<span id="cb18-937"><a href="#cb18-937" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>, tracking_info[<span class="st">"tracking_number"</span>], datetime.utcnow(), order_id)</span>
<span id="cb18-938"><a href="#cb18-938" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-939"><a href="#cb18-939" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notify customer</span></span>
<span id="cb18-940"><a href="#cb18-940" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="va">self</span>.deps[<span class="st">"notification_service"</span>].send_email(</span>
<span id="cb18-941"><a href="#cb18-941" aria-hidden="true" tabindex="-1"></a>            template<span class="op">=</span><span class="st">"order_shipped"</span>,</span>
<span id="cb18-942"><a href="#cb18-942" aria-hidden="true" tabindex="-1"></a>            order_id<span class="op">=</span>order_id,</span>
<span id="cb18-943"><a href="#cb18-943" aria-hidden="true" tabindex="-1"></a>            tracking_info<span class="op">=</span>tracking_info</span>
<span id="cb18-944"><a href="#cb18-944" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-945"><a href="#cb18-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-946"><a href="#cb18-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-947"><a href="#cb18-947" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing with Saga Compensation</span></span>
<span id="cb18-948"><a href="#cb18-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-951"><a href="#cb18-951" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-952"><a href="#cb18-952" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-953"><a href="#cb18-953" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.mark.asyncio</span></span>
<span id="cb18-954"><a href="#cb18-954" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> test_payment_failure_compensation():</span>
<span id="cb18-955"><a href="#cb18-955" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test that inventory is released when payment fails."""</span></span>
<span id="cb18-956"><a href="#cb18-956" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-957"><a href="#cb18-957" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mock payment to fail</span></span>
<span id="cb18-958"><a href="#cb18-958" aria-hidden="true" tabindex="-1"></a>    deps <span class="op">=</span> create_test_deps()</span>
<span id="cb18-959"><a href="#cb18-959" aria-hidden="true" tabindex="-1"></a>    deps[<span class="st">"payment_service"</span>].mock_failure <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-960"><a href="#cb18-960" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-961"><a href="#cb18-961" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> OrderProcessingService(deps)</span>
<span id="cb18-962"><a href="#cb18-962" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-963"><a href="#cb18-963" aria-hidden="true" tabindex="-1"></a>    order_data <span class="op">=</span> {</span>
<span id="cb18-964"><a href="#cb18-964" aria-hidden="true" tabindex="-1"></a>        <span class="st">"customer_id"</span>: <span class="st">"cust_123"</span>,</span>
<span id="cb18-965"><a href="#cb18-965" aria-hidden="true" tabindex="-1"></a>        <span class="st">"items"</span>: [</span>
<span id="cb18-966"><a href="#cb18-966" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"product_id"</span>: <span class="st">"prod_1"</span>, <span class="st">"quantity"</span>: <span class="dv">2</span>, <span class="st">"unit_price"</span>: <span class="st">"29.99"</span>}</span>
<span id="cb18-967"><a href="#cb18-967" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb18-968"><a href="#cb18-968" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shipping_address"</span>: {...}</span>
<span id="cb18-969"><a href="#cb18-969" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-970"><a href="#cb18-970" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-971"><a href="#cb18-971" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This should fail at payment step</span></span>
<span id="cb18-972"><a href="#cb18-972" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>, match<span class="op">=</span><span class="st">"Payment failed"</span>):</span>
<span id="cb18-973"><a href="#cb18-973" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> service.create_order(order_data)</span>
<span id="cb18-974"><a href="#cb18-974" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-975"><a href="#cb18-975" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify compensation occurred</span></span>
<span id="cb18-976"><a href="#cb18-976" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> deps[<span class="st">"inventory_service"</span>].reservations <span class="op">==</span> {}  <span class="co"># Released</span></span>
<span id="cb18-977"><a href="#cb18-977" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> deps[<span class="st">"metrics"</span>][<span class="st">"compensations_triggered"</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb18-978"><a href="#cb18-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-979"><a href="#cb18-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-980"><a href="#cb18-980" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example 4: AI-Powered Customer Support System</span></span>
<span id="cb18-981"><a href="#cb18-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-982"><a href="#cb18-982" aria-hidden="true" tabindex="-1"></a>An intelligent support system using nanobricks with AI capabilities.</span>
<span id="cb18-983"><a href="#cb18-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-984"><a href="#cb18-984" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb18-985"><a href="#cb18-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-988"><a href="#cb18-988" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-989"><a href="#cb18-989" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-990"><a href="#cb18-990" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.ai <span class="im">import</span> AIBrick, ConversationMemory</span>
<span id="cb18-991"><a href="#cb18-991" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.skills <span class="im">import</span> create_mcp_server</span>
<span id="cb18-992"><a href="#cb18-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-993"><a href="#cb18-993" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnalyzeSentiment(AIBrick[<span class="bu">str</span>, Dict]):</span>
<span id="cb18-994"><a href="#cb18-994" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Analyzes customer sentiment using AI."""</span></span>
<span id="cb18-995"><a href="#cb18-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-996"><a href="#cb18-996" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb18-997"><a href="#cb18-997" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(</span>
<span id="cb18-998"><a href="#cb18-998" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-4"</span>,</span>
<span id="cb18-999"><a href="#cb18-999" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb18-1000"><a href="#cb18-1000" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">100</span></span>
<span id="cb18-1001"><a href="#cb18-1001" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-1002"><a href="#cb18-1002" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1003"><a href="#cb18-1003" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, message: <span class="bu">str</span>, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb18-1004"><a href="#cb18-1004" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.complete(</span>
<span id="cb18-1005"><a href="#cb18-1005" aria-hidden="true" tabindex="-1"></a>            system<span class="op">=</span><span class="st">"Analyze sentiment and urgency of customer message"</span>,</span>
<span id="cb18-1006"><a href="#cb18-1006" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>message,</span>
<span id="cb18-1007"><a href="#cb18-1007" aria-hidden="true" tabindex="-1"></a>            response_format<span class="op">=</span>{<span class="st">"sentiment"</span>: <span class="st">"positive/neutral/negative"</span>, <span class="st">"urgency"</span>: <span class="st">"low/medium/high"</span>}</span>
<span id="cb18-1008"><a href="#cb18-1008" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-1009"><a href="#cb18-1009" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response</span>
<span id="cb18-1010"><a href="#cb18-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1011"><a href="#cb18-1011" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateResponse(AIBrick[Dict, <span class="bu">str</span>]):</span>
<span id="cb18-1012"><a href="#cb18-1012" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates contextual support response."""</span></span>
<span id="cb18-1013"><a href="#cb18-1013" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1014"><a href="#cb18-1014" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, knowledge_base: KnowledgeBase):</span>
<span id="cb18-1015"><a href="#cb18-1015" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(model<span class="op">=</span><span class="st">"gpt-4"</span>)</span>
<span id="cb18-1016"><a href="#cb18-1016" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kb <span class="op">=</span> knowledge_base</span>
<span id="cb18-1017"><a href="#cb18-1017" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1018"><a href="#cb18-1018" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> invoke(<span class="va">self</span>, context: Dict, <span class="op">*</span>, deps<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb18-1019"><a href="#cb18-1019" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get relevant knowledge</span></span>
<span id="cb18-1020"><a href="#cb18-1020" aria-hidden="true" tabindex="-1"></a>        docs <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.kb.search(</span>
<span id="cb18-1021"><a href="#cb18-1021" aria-hidden="true" tabindex="-1"></a>            context[<span class="st">"message"</span>],</span>
<span id="cb18-1022"><a href="#cb18-1022" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">=</span><span class="dv">3</span></span>
<span id="cb18-1023"><a href="#cb18-1023" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-1024"><a href="#cb18-1024" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-1025"><a href="#cb18-1025" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.complete(</span>
<span id="cb18-1026"><a href="#cb18-1026" aria-hidden="true" tabindex="-1"></a>            system<span class="op">=</span><span class="st">"""You are a helpful customer support agent.</span></span>
<span id="cb18-1027"><a href="#cb18-1027" aria-hidden="true" tabindex="-1"></a><span class="st">            Use the provided documentation to answer accurately.</span></span>
<span id="cb18-1028"><a href="#cb18-1028" aria-hidden="true" tabindex="-1"></a><span class="st">            Be concise and friendly."""</span>,</span>
<span id="cb18-1029"><a href="#cb18-1029" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>context[<span class="st">"message"</span>],</span>
<span id="cb18-1030"><a href="#cb18-1030" aria-hidden="true" tabindex="-1"></a>            context<span class="op">=</span>{<span class="st">"documentation"</span>: docs},</span>
<span id="cb18-1031"><a href="#cb18-1031" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">500</span></span>
<span id="cb18-1032"><a href="#cb18-1032" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-1033"><a href="#cb18-1033" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-1034"><a href="#cb18-1034" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response</span>
<span id="cb18-1035"><a href="#cb18-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1036"><a href="#cb18-1036" aria-hidden="true" tabindex="-1"></a><span class="co"># Create intelligent support pipeline</span></span>
<span id="cb18-1037"><a href="#cb18-1037" aria-hidden="true" tabindex="-1"></a>support_pipeline <span class="op">=</span> (</span>
<span id="cb18-1038"><a href="#cb18-1038" aria-hidden="true" tabindex="-1"></a>    AnalyzeSentiment()</span>
<span id="cb18-1039"><a href="#cb18-1039" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> RouteByUrgency()</span>
<span id="cb18-1040"><a href="#cb18-1040" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> LoadCustomerHistory()</span>
<span id="cb18-1041"><a href="#cb18-1041" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> GenerateResponse(knowledge_base)</span>
<span id="cb18-1042"><a href="#cb18-1042" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> ValidateResponse()</span>
<span id="cb18-1043"><a href="#cb18-1043" aria-hidden="true" tabindex="-1"></a>).with_skill(<span class="st">"conversation_memory"</span>)</span>
<span id="cb18-1044"><a href="#cb18-1044" aria-hidden="true" tabindex="-1"></a> .with_skill(<span class="st">"observability"</span>, track_ai_usage<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-1045"><a href="#cb18-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1046"><a href="#cb18-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1047"><a href="#cb18-1047" aria-hidden="true" tabindex="-1"></a><span class="fu">## Deployment Best Practices</span></span>
<span id="cb18-1048"><a href="#cb18-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1049"><a href="#cb18-1049" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Container Optimization</span></span>
<span id="cb18-1050"><a href="#cb18-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1051"><a href="#cb18-1051" aria-hidden="true" tabindex="-1"></a><span class="in">```dockerfile</span></span>
<span id="cb18-1052"><a href="#cb18-1052" aria-hidden="true" tabindex="-1"></a><span class="in"># Multi-stage build for smaller images</span></span>
<span id="cb18-1053"><a href="#cb18-1053" aria-hidden="true" tabindex="-1"></a><span class="in">FROM python:3.13-slim as builder</span></span>
<span id="cb18-1054"><a href="#cb18-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1055"><a href="#cb18-1055" aria-hidden="true" tabindex="-1"></a><span class="in">WORKDIR /app</span></span>
<span id="cb18-1056"><a href="#cb18-1056" aria-hidden="true" tabindex="-1"></a><span class="in">COPY requirements.txt .</span></span>
<span id="cb18-1057"><a href="#cb18-1057" aria-hidden="true" tabindex="-1"></a><span class="in">RUN pip install --user -r requirements.txt</span></span>
<span id="cb18-1058"><a href="#cb18-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1059"><a href="#cb18-1059" aria-hidden="true" tabindex="-1"></a><span class="in">FROM python:3.13-slim</span></span>
<span id="cb18-1060"><a href="#cb18-1060" aria-hidden="true" tabindex="-1"></a><span class="in">WORKDIR /app</span></span>
<span id="cb18-1061"><a href="#cb18-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1062"><a href="#cb18-1062" aria-hidden="true" tabindex="-1"></a><span class="in"># Copy only necessary files</span></span>
<span id="cb18-1063"><a href="#cb18-1063" aria-hidden="true" tabindex="-1"></a><span class="in">COPY --from=builder /root/.local /root/.local</span></span>
<span id="cb18-1064"><a href="#cb18-1064" aria-hidden="true" tabindex="-1"></a><span class="in">COPY src/ ./src/</span></span>
<span id="cb18-1065"><a href="#cb18-1065" aria-hidden="true" tabindex="-1"></a><span class="in">COPY nanobrick.toml .</span></span>
<span id="cb18-1066"><a href="#cb18-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1067"><a href="#cb18-1067" aria-hidden="true" tabindex="-1"></a><span class="in"># Non-root user</span></span>
<span id="cb18-1068"><a href="#cb18-1068" aria-hidden="true" tabindex="-1"></a><span class="in">RUN useradd -m -u 1000 appuser</span></span>
<span id="cb18-1069"><a href="#cb18-1069" aria-hidden="true" tabindex="-1"></a><span class="in">USER appuser</span></span>
<span id="cb18-1070"><a href="#cb18-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1071"><a href="#cb18-1071" aria-hidden="true" tabindex="-1"></a><span class="in">ENV PATH=/root/.local/bin:$PATH</span></span>
<span id="cb18-1072"><a href="#cb18-1072" aria-hidden="true" tabindex="-1"></a><span class="in">CMD ["python", "-m", "nanobricks.run", "my-service"]</span></span>
<span id="cb18-1073"><a href="#cb18-1073" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1074"><a href="#cb18-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1075"><a href="#cb18-1075" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Kubernetes Production Config</span></span>
<span id="cb18-1076"><a href="#cb18-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1077"><a href="#cb18-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```yaml</span></span>
<span id="cb18-1078"><a href="#cb18-1078" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb18-1079"><a href="#cb18-1079" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb18-1080"><a href="#cb18-1080" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-1081"><a href="#cb18-1081" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1082"><a href="#cb18-1082" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-1083"><a href="#cb18-1083" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb18-1084"><a href="#cb18-1084" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-1085"><a href="#cb18-1085" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb18-1086"><a href="#cb18-1086" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1087"><a href="#cb18-1087" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb18-1088"><a href="#cb18-1088" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-1089"><a href="#cb18-1089" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb18-1090"><a href="#cb18-1090" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1091"><a href="#cb18-1091" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-1092"><a href="#cb18-1092" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb18-1093"><a href="#cb18-1093" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> service</span></span>
<span id="cb18-1094"><a href="#cb18-1094" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> myregistry/nanobrick-service:v1.0.0</span></span>
<span id="cb18-1095"><a href="#cb18-1095" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-1096"><a href="#cb18-1096" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb18-1097"><a href="#cb18-1097" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb18-1098"><a href="#cb18-1098" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ENVIRONMENT</span></span>
<span id="cb18-1099"><a href="#cb18-1099" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">value</span><span class="kw">:</span><span class="at"> production</span></span>
<span id="cb18-1100"><a href="#cb18-1100" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb18-1101"><a href="#cb18-1101" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb18-1102"><a href="#cb18-1102" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"256Mi"</span></span>
<span id="cb18-1103"><a href="#cb18-1103" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"100m"</span></span>
<span id="cb18-1104"><a href="#cb18-1104" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb18-1105"><a href="#cb18-1105" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"512Mi"</span></span>
<span id="cb18-1106"><a href="#cb18-1106" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb18-1107"><a href="#cb18-1107" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb18-1108"><a href="#cb18-1108" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb18-1109"><a href="#cb18-1109" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb18-1110"><a href="#cb18-1110" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb18-1111"><a href="#cb18-1111" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb18-1112"><a href="#cb18-1112" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb18-1113"><a href="#cb18-1113" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb18-1114"><a href="#cb18-1114" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb18-1115"><a href="#cb18-1115" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /ready</span></span>
<span id="cb18-1116"><a href="#cb18-1116" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb18-1117"><a href="#cb18-1117" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb18-1118"><a href="#cb18-1118" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb18-1119"><a href="#cb18-1119" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb18-1120"><a href="#cb18-1120" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb18-1121"><a href="#cb18-1121" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb18-1122"><a href="#cb18-1122" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-1123"><a href="#cb18-1123" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1124"><a href="#cb18-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-1125"><a href="#cb18-1125" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-1126"><a href="#cb18-1126" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1127"><a href="#cb18-1127" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-1128"><a href="#cb18-1128" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb18-1129"><a href="#cb18-1129" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8000</span></span>
<span id="cb18-1130"><a href="#cb18-1130" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb18-1131"><a href="#cb18-1131" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb18-1132"><a href="#cb18-1132" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> autoscaling/v2</span></span>
<span id="cb18-1133"><a href="#cb18-1133" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> HorizontalPodAutoscaler</span></span>
<span id="cb18-1134"><a href="#cb18-1134" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-1135"><a href="#cb18-1135" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service-hpa</span></span>
<span id="cb18-1136"><a href="#cb18-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-1137"><a href="#cb18-1137" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scaleTargetRef</span><span class="kw">:</span></span>
<span id="cb18-1138"><a href="#cb18-1138" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb18-1139"><a href="#cb18-1139" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb18-1140"><a href="#cb18-1140" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nanobrick-service</span></span>
<span id="cb18-1141"><a href="#cb18-1141" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb18-1142"><a href="#cb18-1142" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">maxReplicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb18-1143"><a href="#cb18-1143" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics</span><span class="kw">:</span></span>
<span id="cb18-1144"><a href="#cb18-1144" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb18-1145"><a href="#cb18-1145" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb18-1146"><a href="#cb18-1146" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cpu</span></span>
<span id="cb18-1147"><a href="#cb18-1147" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb18-1148"><a href="#cb18-1148" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb18-1149"><a href="#cb18-1149" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">70</span></span>
<span id="cb18-1150"><a href="#cb18-1150" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Resource</span></span>
<span id="cb18-1151"><a href="#cb18-1151" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resource</span><span class="kw">:</span></span>
<span id="cb18-1152"><a href="#cb18-1152" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> memory</span></span>
<span id="cb18-1153"><a href="#cb18-1153" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">target</span><span class="kw">:</span></span>
<span id="cb18-1154"><a href="#cb18-1154" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Utilization</span></span>
<span id="cb18-1155"><a href="#cb18-1155" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">averageUtilization</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb18-1156"><a href="#cb18-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1157"><a href="#cb18-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1158"><a href="#cb18-1158" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Monitoring Setup</span></span>
<span id="cb18-1159"><a href="#cb18-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1162"><a href="#cb18-1162" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-1163"><a href="#cb18-1163" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-1164"><a href="#cb18-1164" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.observability <span class="im">import</span> create_monitoring_stack</span>
<span id="cb18-1165"><a href="#cb18-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1166"><a href="#cb18-1166" aria-hidden="true" tabindex="-1"></a>monitoring <span class="op">=</span> create_monitoring_stack(</span>
<span id="cb18-1167"><a href="#cb18-1167" aria-hidden="true" tabindex="-1"></a>    service_name<span class="op">=</span><span class="st">"my-service"</span>,</span>
<span id="cb18-1168"><a href="#cb18-1168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1169"><a href="#cb18-1169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Metrics with Prometheus</span></span>
<span id="cb18-1170"><a href="#cb18-1170" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>{</span>
<span id="cb18-1171"><a href="#cb18-1171" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://prometheus:9090"</span>,</span>
<span id="cb18-1172"><a href="#cb18-1172" aria-hidden="true" tabindex="-1"></a>        <span class="st">"custom_metrics"</span>: [</span>
<span id="cb18-1173"><a href="#cb18-1173" aria-hidden="true" tabindex="-1"></a>            <span class="st">"orders_processed_total"</span>,</span>
<span id="cb18-1174"><a href="#cb18-1174" aria-hidden="true" tabindex="-1"></a>            <span class="st">"payment_amount_sum"</span>,</span>
<span id="cb18-1175"><a href="#cb18-1175" aria-hidden="true" tabindex="-1"></a>            <span class="st">"processing_duration_seconds"</span></span>
<span id="cb18-1176"><a href="#cb18-1176" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-1177"><a href="#cb18-1177" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1178"><a href="#cb18-1178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1179"><a href="#cb18-1179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tracing with Jaeger</span></span>
<span id="cb18-1180"><a href="#cb18-1180" aria-hidden="true" tabindex="-1"></a>    tracing<span class="op">=</span>{</span>
<span id="cb18-1181"><a href="#cb18-1181" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://jaeger:14268"</span>,</span>
<span id="cb18-1182"><a href="#cb18-1182" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_rate"</span>: <span class="fl">0.1</span>  <span class="co"># 10% sampling</span></span>
<span id="cb18-1183"><a href="#cb18-1183" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1184"><a href="#cb18-1184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1185"><a href="#cb18-1185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logging with ELK</span></span>
<span id="cb18-1186"><a href="#cb18-1186" aria-hidden="true" tabindex="-1"></a>    logging<span class="op">=</span>{</span>
<span id="cb18-1187"><a href="#cb18-1187" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endpoint"</span>: <span class="st">"http://elasticsearch:9200"</span>,</span>
<span id="cb18-1188"><a href="#cb18-1188" aria-hidden="true" tabindex="-1"></a>        <span class="st">"index"</span>: <span class="st">"nanobricks-prod"</span>,</span>
<span id="cb18-1189"><a href="#cb18-1189" aria-hidden="true" tabindex="-1"></a>        <span class="st">"retention_days"</span>: <span class="dv">30</span></span>
<span id="cb18-1190"><a href="#cb18-1190" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1191"><a href="#cb18-1191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1192"><a href="#cb18-1192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerting rules</span></span>
<span id="cb18-1193"><a href="#cb18-1193" aria-hidden="true" tabindex="-1"></a>    alerts<span class="op">=</span>[</span>
<span id="cb18-1194"><a href="#cb18-1194" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb18-1195"><a href="#cb18-1195" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: <span class="st">"high_error_rate"</span>,</span>
<span id="cb18-1196"><a href="#cb18-1196" aria-hidden="true" tabindex="-1"></a>            <span class="st">"condition"</span>: <span class="st">"rate(errors_total[5m]) &gt; 0.01"</span>,</span>
<span id="cb18-1197"><a href="#cb18-1197" aria-hidden="true" tabindex="-1"></a>            <span class="st">"severity"</span>: <span class="st">"critical"</span>,</span>
<span id="cb18-1198"><a href="#cb18-1198" aria-hidden="true" tabindex="-1"></a>            <span class="st">"notify"</span>: [<span class="st">"oncall@company.com"</span>]</span>
<span id="cb18-1199"><a href="#cb18-1199" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb18-1200"><a href="#cb18-1200" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb18-1201"><a href="#cb18-1201" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: <span class="st">"high_latency"</span>, </span>
<span id="cb18-1202"><a href="#cb18-1202" aria-hidden="true" tabindex="-1"></a>            <span class="st">"condition"</span>: <span class="st">"histogram_quantile(0.99, latency_seconds) &gt; 1"</span>,</span>
<span id="cb18-1203"><a href="#cb18-1203" aria-hidden="true" tabindex="-1"></a>            <span class="st">"severity"</span>: <span class="st">"warning"</span>,</span>
<span id="cb18-1204"><a href="#cb18-1204" aria-hidden="true" tabindex="-1"></a>            <span class="st">"notify"</span>: [<span class="st">"team@company.com"</span>]</span>
<span id="cb18-1205"><a href="#cb18-1205" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-1206"><a href="#cb18-1206" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-1207"><a href="#cb18-1207" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-1208"><a href="#cb18-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1209"><a href="#cb18-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1210"><a href="#cb18-1210" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Tuning</span></span>
<span id="cb18-1211"><a href="#cb18-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1212"><a href="#cb18-1212" aria-hidden="true" tabindex="-1"></a><span class="fu">### Database Connection Pooling</span></span>
<span id="cb18-1213"><a href="#cb18-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1216"><a href="#cb18-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-1217"><a href="#cb18-1217" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-1218"><a href="#cb18-1218" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.performance <span class="im">import</span> create_connection_pool</span>
<span id="cb18-1219"><a href="#cb18-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1220"><a href="#cb18-1220" aria-hidden="true" tabindex="-1"></a>db_pool <span class="op">=</span> create_connection_pool(</span>
<span id="cb18-1221"><a href="#cb18-1221" aria-hidden="true" tabindex="-1"></a>    <span class="st">"postgresql://localhost/mydb"</span>,</span>
<span id="cb18-1222"><a href="#cb18-1222" aria-hidden="true" tabindex="-1"></a>    min_connections<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb18-1223"><a href="#cb18-1223" aria-hidden="true" tabindex="-1"></a>    max_connections<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb18-1224"><a href="#cb18-1224" aria-hidden="true" tabindex="-1"></a>    connection_timeout<span class="op">=</span><span class="fl">5.0</span>,</span>
<span id="cb18-1225"><a href="#cb18-1225" aria-hidden="true" tabindex="-1"></a>    idle_timeout<span class="op">=</span><span class="fl">300.0</span>,</span>
<span id="cb18-1226"><a href="#cb18-1226" aria-hidden="true" tabindex="-1"></a>    max_lifetime<span class="op">=</span><span class="fl">3600.0</span></span>
<span id="cb18-1227"><a href="#cb18-1227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-1228"><a href="#cb18-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1229"><a href="#cb18-1229" aria-hidden="true" tabindex="-1"></a><span class="co"># Use with nanobricks</span></span>
<span id="cb18-1230"><a href="#cb18-1230" aria-hidden="true" tabindex="-1"></a>deps <span class="op">=</span> ServiceDeps(db<span class="op">=</span>db_pool, ...)</span>
<span id="cb18-1231"><a href="#cb18-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1232"><a href="#cb18-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1233"><a href="#cb18-1233" aria-hidden="true" tabindex="-1"></a><span class="fu">### Caching Strategy</span></span>
<span id="cb18-1234"><a href="#cb18-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1237"><a href="#cb18-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-1238"><a href="#cb18-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-1239"><a href="#cb18-1239" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.performance <span class="im">import</span> MultiLevelCache</span>
<span id="cb18-1240"><a href="#cb18-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1241"><a href="#cb18-1241" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> MultiLevelCache(</span>
<span id="cb18-1242"><a href="#cb18-1242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L1: In-memory LRU cache</span></span>
<span id="cb18-1243"><a href="#cb18-1243" aria-hidden="true" tabindex="-1"></a>    memory_cache<span class="op">=</span>{<span class="st">"max_size"</span>: <span class="dv">1000</span>, <span class="st">"ttl"</span>: <span class="dv">60</span>},</span>
<span id="cb18-1244"><a href="#cb18-1244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1245"><a href="#cb18-1245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L2: Redis cache</span></span>
<span id="cb18-1246"><a href="#cb18-1246" aria-hidden="true" tabindex="-1"></a>    redis_cache<span class="op">=</span>{<span class="st">"url"</span>: <span class="st">"redis://localhost"</span>, <span class="st">"ttl"</span>: <span class="dv">3600</span>},</span>
<span id="cb18-1247"><a href="#cb18-1247" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1248"><a href="#cb18-1248" aria-hidden="true" tabindex="-1"></a>    <span class="co"># L3: CDN cache (for read-through)</span></span>
<span id="cb18-1249"><a href="#cb18-1249" aria-hidden="true" tabindex="-1"></a>    cdn_cache<span class="op">=</span>{<span class="st">"enabled"</span>: <span class="va">True</span>, <span class="st">"regions"</span>: [<span class="st">"us-east-1"</span>, <span class="st">"eu-west-1"</span>]}</span>
<span id="cb18-1250"><a href="#cb18-1250" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-1251"><a href="#cb18-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1252"><a href="#cb18-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to expensive operations</span></span>
<span id="cb18-1253"><a href="#cb18-1253" aria-hidden="true" tabindex="-1"></a>cached_processor <span class="op">=</span> processor.with_skill(<span class="st">"cache"</span>, cache<span class="op">=</span>cache)</span>
<span id="cb18-1254"><a href="#cb18-1254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1255"><a href="#cb18-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1256"><a href="#cb18-1256" aria-hidden="true" tabindex="-1"></a><span class="fu">## Security Hardening</span></span>
<span id="cb18-1257"><a href="#cb18-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1258"><a href="#cb18-1258" aria-hidden="true" tabindex="-1"></a><span class="fu">### API Security</span></span>
<span id="cb18-1259"><a href="#cb18-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1262"><a href="#cb18-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-1263"><a href="#cb18-1263" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-1264"><a href="#cb18-1264" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nanobricks.security <span class="im">import</span> secure_api</span>
<span id="cb18-1265"><a href="#cb18-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1266"><a href="#cb18-1266" aria-hidden="true" tabindex="-1"></a>secure_service <span class="op">=</span> secure_api(</span>
<span id="cb18-1267"><a href="#cb18-1267" aria-hidden="true" tabindex="-1"></a>    service,</span>
<span id="cb18-1268"><a href="#cb18-1268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1269"><a href="#cb18-1269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Authentication</span></span>
<span id="cb18-1270"><a href="#cb18-1270" aria-hidden="true" tabindex="-1"></a>    auth<span class="op">=</span>{</span>
<span id="cb18-1271"><a href="#cb18-1271" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type"</span>: <span class="st">"jwt"</span>,</span>
<span id="cb18-1272"><a href="#cb18-1272" aria-hidden="true" tabindex="-1"></a>        <span class="st">"secret"</span>: JWT_SECRET,</span>
<span id="cb18-1273"><a href="#cb18-1273" aria-hidden="true" tabindex="-1"></a>        <span class="st">"algorithm"</span>: <span class="st">"RS256"</span>,</span>
<span id="cb18-1274"><a href="#cb18-1274" aria-hidden="true" tabindex="-1"></a>        <span class="st">"issuer"</span>: <span class="st">"https://auth.company.com"</span></span>
<span id="cb18-1275"><a href="#cb18-1275" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1276"><a href="#cb18-1276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1277"><a href="#cb18-1277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rate limiting per user</span></span>
<span id="cb18-1278"><a href="#cb18-1278" aria-hidden="true" tabindex="-1"></a>    rate_limit<span class="op">=</span>{</span>
<span id="cb18-1279"><a href="#cb18-1279" aria-hidden="true" tabindex="-1"></a>        <span class="st">"requests_per_minute"</span>: <span class="dv">100</span>,</span>
<span id="cb18-1280"><a href="#cb18-1280" aria-hidden="true" tabindex="-1"></a>        <span class="st">"burst"</span>: <span class="dv">20</span>,</span>
<span id="cb18-1281"><a href="#cb18-1281" aria-hidden="true" tabindex="-1"></a>        <span class="st">"key"</span>: <span class="kw">lambda</span> req: req.user_id</span>
<span id="cb18-1282"><a href="#cb18-1282" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1283"><a href="#cb18-1283" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1284"><a href="#cb18-1284" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Input validation</span></span>
<span id="cb18-1285"><a href="#cb18-1285" aria-hidden="true" tabindex="-1"></a>    validation<span class="op">=</span>{</span>
<span id="cb18-1286"><a href="#cb18-1286" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_body_size"</span>: <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>,  <span class="co"># 1MB</span></span>
<span id="cb18-1287"><a href="#cb18-1287" aria-hidden="true" tabindex="-1"></a>        <span class="st">"allowed_content_types"</span>: [<span class="st">"application/json"</span>],</span>
<span id="cb18-1288"><a href="#cb18-1288" aria-hidden="true" tabindex="-1"></a>        <span class="st">"schema_validation"</span>: <span class="va">True</span></span>
<span id="cb18-1289"><a href="#cb18-1289" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-1290"><a href="#cb18-1290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-1291"><a href="#cb18-1291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Security headers</span></span>
<span id="cb18-1292"><a href="#cb18-1292" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{</span>
<span id="cb18-1293"><a href="#cb18-1293" aria-hidden="true" tabindex="-1"></a>        <span class="st">"X-Frame-Options"</span>: <span class="st">"DENY"</span>,</span>
<span id="cb18-1294"><a href="#cb18-1294" aria-hidden="true" tabindex="-1"></a>        <span class="st">"X-Content-Type-Options"</span>: <span class="st">"nosniff"</span>,</span>
<span id="cb18-1295"><a href="#cb18-1295" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Strict-Transport-Security"</span>: <span class="st">"max-age=31536000"</span></span>
<span id="cb18-1296"><a href="#cb18-1296" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-1297"><a href="#cb18-1297" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-1298"><a href="#cb18-1298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1299"><a href="#cb18-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1300"><a href="#cb18-1300" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb18-1301"><a href="#cb18-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1302"><a href="#cb18-1302" aria-hidden="true" tabindex="-1"></a>These production examples demonstrate:</span>
<span id="cb18-1303"><a href="#cb18-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1304"><a href="#cb18-1304" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Complete Systems**: Full applications built with nanobricks</span>
<span id="cb18-1305"><a href="#cb18-1305" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Error Handling**: Proper error handling and compensation</span>
<span id="cb18-1306"><a href="#cb18-1306" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Testing**: Comprehensive testing strategies</span>
<span id="cb18-1307"><a href="#cb18-1307" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Deployment**: Production-ready deployment configurations</span>
<span id="cb18-1308"><a href="#cb18-1308" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Monitoring**: Observability and alerting setup</span>
<span id="cb18-1309"><a href="#cb18-1309" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Performance**: Optimization techniques</span>
<span id="cb18-1310"><a href="#cb18-1310" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Security**: Hardening for production use</span>
<span id="cb18-1311"><a href="#cb18-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1312"><a href="#cb18-1312" aria-hidden="true" tabindex="-1"></a>Each example can be adapted and extended for your specific use case. The modular nature of nanobricks makes it easy to swap components, add new features, or scale specific parts of your system independently.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>